<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Wallet Platform - Full Demo</title>
<style>
  body { font-family: Arial, sans-serif; max-width: 900px; margin: auto; padding: 1rem; background:#f4f4f4; }
  h1, h2 { text-align: center; }
  .hidden { display: none; }
  label { display: block; margin-top: 0.8rem; }
  input, select { padding: 0.4rem; width: 100%; max-width: 300px; }
  button { margin-top: 1rem; padding: 0.6rem 1rem; cursor: pointer; }
  #dashboard, #adminDashboard { margin-top: 2rem; }
  table { border-collapse: collapse; width: 100%; margin-top: 1rem; }
  th, td { border: 1px solid #ccc; padding: 0.4rem; text-align: center; }
  .error { color: red; margin-top: 0.5rem; }
  .success { color: green; margin-top: 0.5rem; }
  #chargeGraph { width: 100%; max-width: 600px; margin: 1rem auto; }
</style>
</head>
<body>

<h1>Wallet Platform Demo</h1>

<div id="loginSection">
  <h2>Login</h2>
  <label>Username:
    <input type="text" id="loginUsername" />
  </label>
  <label>Password:
    <input type="password" id="loginPassword" />
  </label>
  <button id="loginBtn">Login</button>
  <div id="loginError" class="error"></div>
</div>

<div id="dashboard" class="hidden">
  <h2>Welcome, <span id="userFullName"></span> (<span id="userRole"></span>)</h2>
  <div>
    <strong>Your Wallet Balance (KES):</strong> <span id="walletBalance"></span>
  </div>

  <h3>Transfer Money</h3>
  <label>Recipient Username:
    <input type="text" id="recipientUsername" />
  </label>
  <label>Amount to Send (KES):
    <input type="number" id="transferAmount" min="1" />
  </label>
  <div>Transaction Charge: <span id="chargeDisplay">0</span> KES (Max 1000 KES)</div>
  <button id="transferBtn">Send Money</button>
  <div id="transferMessage"></div>

  <button id="logoutBtn" style="margin-top: 2rem;">Logout</button>
</div>

<div id="adminDashboard" class="hidden">
  <h2>Admin Dashboard</h2>

  <h3>Registered Users</h3>
  <table id="usersTable">
    <thead><tr><th>Username</th><th>Full Name</th><th>Role</th><th>Balance (KES)</th></tr></thead>
    <tbody></tbody>
  </table>

  <h3>Transaction Charges Ledger</h3>
  <table id="chargesLedger">
    <thead><tr><th>Timestamp</th><th>Sender</th><th>Recipient</th><th>Amount</th><th>Charge</th></tr></thead>
    <tbody></tbody>
  </table>

  <canvas id="chargeGraph" height="300"></canvas>

  <button id="adminLogoutBtn" style="margin-top: 2rem;">Logout</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
(() => {
  // Hardcoded users with roles and balances
  const users = {
    admin: {
      username: 'admin',
      password: 'adminpass',
      fullName: 'System Administrator',
      role: 'admin',
      balance: 0
    },
    kilush: {
      username: 'kilush',
      password: 'kilush123',
      fullName: 'Kilush Mutua',
      role: 'user',
      balance: 15000
    },
    schwadz: {
      username: 'schwadz',
      password: 'schwadz123',
      fullName: 'Schwadz Mwangi',
      role: 'user',
      balance: 10000
    },
    moses: {
      username: 'moses',
      password: 'moses123',
      fullName: 'Moses Otieno',
      role: 'sub-admin',
      balance: 5000
    }
  };

  // Transaction charge capped at 1000 KES, 1% charge per transaction
  const TRANSACTION_CHARGE_RATE = 0.01;
  const MAX_CHARGE = 1000;

  // Transaction history array
  let transactions = [];

  // Current logged in user
  let currentUser = null;

  // Elements
  const loginSection = document.getElementById('loginSection');
  const loginUsername = document.getElementById('loginUsername');
  const loginPassword = document.getElementById('loginPassword');
  const loginBtn = document.getElementById('loginBtn');
  const loginError = document.getElementById('loginError');

  const dashboard = document.getElementById('dashboard');
  const userFullName = document.getElementById('userFullName');
  const userRole = document.getElementById('userRole');
  const walletBalance = document.getElementById('walletBalance');
  const recipientUsername = document.getElementById('recipientUsername');
  const transferAmount = document.getElementById('transferAmount');
  const chargeDisplay = document.getElementById('chargeDisplay');
  const transferBtn = document.getElementById('transferBtn');
  const transferMessage = document.getElementById('transferMessage');
  const logoutBtn = document.getElementById('logoutBtn');

  const adminDashboard = document.getElementById('adminDashboard');
  const usersTableBody = document.querySelector('#usersTable tbody');
  const chargesLedgerBody = document.querySelector('#chargesLedger tbody');
  const adminLogoutBtn = document.getElementById('adminLogoutBtn');
  const chargeGraphCanvas = document.getElementById('chargeGraph');

  // Calculate charge for an amount
  function calculateCharge(amount) {
    const charge = amount * TRANSACTION_CHARGE_RATE;
    return charge > MAX_CHARGE ? MAX_CHARGE : charge;
  }

  // Update charge display when amount changes
  transferAmount.addEventListener('input', () => {
    let amount = parseFloat(transferAmount.value);
    if (isNaN(amount) || amount <= 0) {
      chargeDisplay.textContent = '0';
    } else {
      chargeDisplay.textContent = calculateCharge(amount).toFixed(2);
    }
  });

  // Login handler
  loginBtn.addEventListener('click', () => {
    const username = loginUsername.value.trim().toLowerCase();
    const password = loginPassword.value;

    loginError.textContent = '';
    transferMessage.textContent = '';

    if (!users[username]) {
      loginError.textContent = 'Invalid username or password.';
      return;
    }
    if (users[username].password !== password) {
      loginError.textContent = 'Invalid username or password.';
      return;
    }
    currentUser = users[username];

    // Show dashboard or admin dashboard based on role
    loginSection.classList.add('hidden');
    if (currentUser.role === 'admin' || currentUser.role === 'sub-admin') {
      adminDashboard.classList.remove('hidden');
      dashboard.classList.add('hidden');
      renderAdminDashboard();
    } else {
      dashboard.classList.remove('hidden');
      adminDashboard.classList.add('hidden');
      renderUserDashboard();
    }
  });

  // Render user dashboard info
  function renderUserDashboard() {
    userFullName.textContent = currentUser.fullName;
    userRole.textContent = currentUser.role;
    walletBalance.textContent = currentUser.balance.toFixed(2);
    recipientUsername.value = '';
    transferAmount.value = '';
    chargeDisplay.textContent = '0';
    transferMessage.textContent = '';
  }

  // Render admin dashboard info
  function renderAdminDashboard() {
    userFullName.textContent = currentUser.fullName;
    userRole.textContent = currentUser.role;

    // Populate users table
    usersTableBody.innerHTML = '';
    Object.values(users).forEach(user => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${user.username}</td>
        <td>${user.fullName}</td>
        <td>${user.role}</td>
        <td>${user.balance.toFixed(2)}</td>
      `;
      usersTableBody.appendChild(row);
    });

    // Populate transaction charges ledger
    chargesLedgerBody.innerHTML = '';
    transactions.forEach(tx => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${new Date(tx.timestamp).toLocaleString()}</td>
        <td>${tx.sender}</td>
        <td>${tx.recipient}</td>
        <td>${tx.amount.toFixed(2)}</td>
        <td>${tx.charge.toFixed(2)}</td>
      `;
      chargesLedgerBody.appendChild(row);
    });

    renderChargeGraph();
  }

  // Render charge graph by currency (KES only here)
  function renderChargeGraph() {
    const ctx = chargeGraphCanvas.getContext('2d');
    // Sum charges per day for last 30 days
    const chargesByDay = {};

    const today = new Date();
    for(let i=29; i>=0; i--) {
      const d = new Date(today);
      d.setDate(d.getDate()-i);
      const key = d.toISOString().slice(0,10);
      chargesByDay[key] = 0;
    }

    transactions.forEach(tx => {
      const dateKey = new Date(tx.timestamp).toISOString().slice(0,10);
      if (chargesByDay.hasOwnProperty(dateKey)) {
        chargesByDay[dateKey] += tx.charge;
      }
    });

    const labels = Object.keys(chargesByDay);
    const data = Object.values(chargesByDay);

    if (window.chargeChart) {
      window.chargeChart.destroy();
    }

    window.chargeChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [{
          label: 'Transaction Charges (KES)',
          data,
          borderColor: 'rgb(75, 192, 192)',
          tension: 0.3,
          fill: false,
        }]
      },
      options: {
        scales: {
          x: { ticks: { maxRotation: 90, minRotation: 45 } },
          y: { beginAtZero: true }
        }
      }
    });
  }

  // Transfer button handler
  transferBtn.addEventListener('click', () => {
    transferMessage.textContent = '';
    transferMessage.className = '';

    const recipient = recipientUsername.value.trim().toLowerCase();
    const amount = parseFloat(transferAmount.value);

    if (!recipient || !users[recipient]) {
      transferMessage.textContent = 'Invalid recipient username.';
      transferMessage.className = 'error';
      return;
    }
    if (recipient === currentUser.username) {
      transferMessage.textContent = 'You cannot transfer to yourself.';
      transferMessage.className = 'error';
      return;
    }
    if (isNaN(amount) || amount <= 0) {
      transferMessage.textContent = 'Enter a valid amount greater than 0.';
      transferMessage.className = 'error';
      return;
    }

    // Calculate charge
    const charge = calculateCharge(amount);

    // Check sender balance (charge debited separately, sender must have amount + charge)
    if (currentUser.balance < (amount + charge)) {
      transferMessage.textContent = `Insufficient balance. You need KES ${(amount + charge).toFixed(2)} including charges.`;
      transferMessage.className = 'error';
      return;
    }

    // Check for duplicate transaction within last 1 minute
    const now = Date.now();
    const duplicateTx = transactions.find(tx => 
      tx.sender === currentUser.username &&
      tx.recipient === recipient &&
      tx.amount === amount &&
      (now - tx.timestamp) < 60000
    );
    if (duplicateTx) {
      transferMessage.textContent = 'Duplicate transaction detected within 1 minute window.';
      transferMessage.className = 'error';
      return;
    }

    // Confirm recipient details (simple prompt)
    const confirmText = `Send KES ${amount.toFixed(2)} + charge KES ${charge.toFixed(2)} to ${users[recipient].fullName} (${recipient})?`;
    if (!confirm(confirmText)) {
      return;
    }

    // Perform transfer
    currentUser.balance -= (amount + charge);
    users[recipient].balance += amount;

    // Log transaction
    transactions.push({
      timestamp: now,
      sender: currentUser.username,
      recipient,
      amount,
      charge
    });

    transferMessage.textContent = 'Transfer successful!';
    transferMessage.className = 'success';

    // Update dashboard
    renderUserDashboard();
    if (currentUser.role === 'admin' || currentUser.role === 'sub-admin') {
      renderAdminDashboard();
    }
  });

  // Logout handlers
  logoutBtn.addEventListener('click', () => {
    currentUser = null;
    dashboard.classList.add('hidden');
    loginSection.classList.remove('hidden');
    loginUsername.value = '';
    loginPassword.value = '';
    loginError.textContent = '';
    transferMessage.textContent = '';
  });

  adminLogoutBtn.addEventListener('click', () => {
    currentUser = null;
    adminDashboard.classList.add('hidden');
    loginSection.classList.remove('hidden');
    loginUsername.value = '';
    loginPassword.value = '';
    loginError.textContent = '';
    transferMessage.textContent = '';
  });
})();
</script>

</body>
</html>
