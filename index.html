<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Wallet Platform</title>
  <style>
    body { font-family: Arial; margin: 20px; }
    .hidden { display: none; }
    .dashboard, #transferSection, #logoutBtn, #adminGraphs { margin-top: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background: #eee; }
  </style>
</head>
<body>
  <h2>Wallet Platform</h2>

  <div id="loginSection">
    <h3>Login</h3>
    <input id="loginUsername" placeholder="Username"><br>
    <input id="loginPassword" type="password" placeholder="Password"><br>
    <button onclick="login()">Login</button>
    <p id="loginError" style="color:red;"></p>
  </div>

  <button id="logoutBtn" class="hidden" onclick="logout()">Logout</button>

  <div id="userDashboard" class="dashboard hidden">
    <h3>Welcome, <span id="userName"></span></h3>
    <p>Wallet: <span id="walletBalance"></span> KES</p>
    <p>Charges Wallet: <span id="chargeWalletBalance"></span> KES</p>

    <div id="transferSection">
      <h4>Transfer Money (Wallet to Wallet)</h4>
      <input id="recipientWallet" placeholder="Recipient Wallet" onblur="showRecipientInfo()"><br>
      <p id="recipientInfo" style="color:gray;"></p>
      <input id="amountToSend" type="number" placeholder="Amount"><br>
      <input id="authPin" type="password" placeholder="Authorization PIN"><br>
      <button onclick="initiateTransfer()">Send</button>
      <p id="transferStatus" style="color:green;"></p>

      <hr>
      <h4>Deposit Funds (Manual / Physical)</h4>
      <input id="depositAmount" type="number" placeholder="Deposit Amount"><br>
      <button onclick="recordPhysicalDeposit()">Deposit</button>
      <p id="depositStatus" style="color:green;"></p>

      <hr>
      <h4>Link Bank Card</h4>
      <input id="bankCardNumber" placeholder="Card Number"><br>
      <button onclick="saveBankCard()">Save Card</button>
      <p id="cardStatus" style="color:green;"></p>

      <hr>
      <h4>Send to Bank Account</h4>
      <input id="bankAccountNumber" placeholder="Bank Account Number"><br>
      <input id="bankAmount" type="number" placeholder="Amount"><br>
      <input id="bankPin" type="password" placeholder="Authorization PIN"><br>
      <button onclick="sendToBank()">Send</button>
      <p id="bankStatus" style="color:green;"></p>
    </div>

    <h4>Transaction History</h4>
    <table id="transactionTable">
      <thead><tr><th>Date</th><th>To</th><th>Amount</th><th>Charge</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="adminDashboard" class="dashboard hidden">
    <h3>Welcome, Admin</h3>
    <p>Admin Trading Wallet: <span id="adminTradingWallet"></span> KES</p>
    <p>Admin Charge Wallet: <span id="adminChargeWallet"></span> KES</p>

    <div id="adminGraphs">
      <h4>Graph: Total Transfers</h4>
      <canvas id="transferGraph" width="400" height="200"></canvas>
      <h4>Graph: Charges Collected</h4>
      <canvas id="chargeGraph" width="400" height="200"></canvas>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const users = {
      kilush: {
        password: "pass123",
        pin: "1234",
        wallet: 10000,
        charges: 0,
        email: "kilush@email.com",
        linkedCard: "",
        usedPhysicalDeposit: false,
        history: []
      },
      Schwadz: {
        password: "schwadz123",
        pin: "1234",
        wallet: 10000,
        charges: 0,
        email: "schwadz@email.com",
        linkedCard: "",
        usedPhysicalDeposit: false,
        history: []
      },
      Moses: {
        password: "moses123",
        pin: "1234",
        wallet: 10000,
        charges: 0,
        email: "moses@email.com",
        linkedCard: "",
        usedPhysicalDeposit: false,
        history: []
      }
    };

    const admin = {
      username: "admin",
      password: "admin123",
      tradingWallet: 10000,
      chargeWallet: 50000
    };

    let currentUser = null;

    function login() {
      const uname = document.getElementById("loginUsername").value;
      const pass = document.getElementById("loginPassword").value;
      document.getElementById("loginError").innerText = "";

      if (uname === admin.username && pass === admin.password) {
        currentUser = "admin";
        showAdminDashboard();
      } else if (users[uname] && users[uname].password === pass) {
        currentUser = uname;
        showUserDashboard();
      } else {
        document.getElementById("loginError").innerText = "Invalid credentials.";
      }
    }

    function showUserDashboard() {
      document.getElementById("loginSection").classList.add("hidden");
      document.getElementById("logoutBtn").classList.remove("hidden");
      document.getElementById("userDashboard").classList.remove("hidden");

      const user = users[currentUser];
      document.getElementById("userName").innerText = currentUser;
      document.getElementById("walletBalance").innerText = user.wallet.toFixed(2);
      document.getElementById("chargeWalletBalance").innerText = user.charges.toFixed(2);

      loadTransactionHistory(currentUser);
    }

    function showAdminDashboard() {
      document.getElementById("loginSection").classList.add("hidden");
      document.getElementById("logoutBtn").classList.remove("hidden");
      document.getElementById("adminDashboard").classList.remove("hidden");

      document.getElementById("adminTradingWallet").innerText = admin.tradingWallet.toFixed(2);
      document.getElementById("adminChargeWallet").innerText = admin.chargeWallet.toFixed(2);

      renderGraphs();
    }

    function logout() {
      currentUser = null;
      location.reload();
    }

    function showRecipientInfo() {
      const recipientWallet = document.getElementById("recipientWallet").value;
      const infoBox = document.getElementById("recipientInfo");
      if (users[recipientWallet]) {
        infoBox.innerText = `Recipient found: ${recipientWallet}`;
      } else {
        infoBox.innerText = "Recipient not found.";
      }
    }

    function initiateTransfer() {
      const recipientWallet = document.getElementById("recipientWallet").value;
      const amount = parseFloat(document.getElementById("amountToSend").value);
      const pin = document.getElementById("authPin").value;
      const sender = users[currentUser];

      document.getElementById("transferStatus").innerText = "";

      if (!users[recipientWallet]) return alert("Recipient wallet not found.");
      if (recipientWallet === currentUser) return alert("Cannot send to yourself.");
      if (isNaN(amount) || amount <= 0) return alert("Enter a valid amount.");
      if (pin !== sender.pin) return alert("Incorrect PIN.");

      const now = new Date();
      const lastTx = sender.history[sender.history.length - 1];
      if (lastTx && lastTx.to === recipientWallet && lastTx.amount === amount && now - new Date(lastTx.date) < 60000) {
        return alert("Duplicate transfer detected within 1 minute.");
      }

      let charge = 0;
      if (amount > 250) charge = Math.min(amount * 0.01, 1000);

      const totalDebit = amount + charge;
      if (sender.wallet < totalDebit) return alert("Insufficient balance.");

      sender.wallet -= totalDebit;
      sender.charges += charge;
      users[recipientWallet].wallet += amount;

      sender.history.push({ date: now.toLocaleString(), to: recipientWallet, amount, charge });
      admin.tradingWallet += amount;
      admin.chargeWallet += charge;

      document.getElementById("walletBalance").innerText = sender.wallet.toFixed(2);
      document.getElementById("chargeWalletBalance").innerText = sender.charges.toFixed(2);
      document.getElementById("transferStatus").innerText = "Transfer complete.";

      document.getElementById("recipientWallet").value = "";
      document.getElementById("amountToSend").value = "";
      document.getElementById("authPin").value = "";
      document.getElementById("recipientInfo").innerText = "";

      loadTransactionHistory(currentUser);
    }

    function loadTransactionHistory(userKey) {
      const table = document.getElementById("transactionTable").querySelector("tbody");
      table.innerHTML = "";
      users[userKey].history.forEach(tx => {
        const row = `<tr><td>${tx.date}</td><td>${tx.to}</td><td>${tx.amount}</td><td>${tx.charge}</td></tr>`;
        table.innerHTML += row;
      });
    }

    function recordPhysicalDeposit() {
      const amount = parseFloat(document.getElementById("depositAmount").value);
      if (isNaN(amount) || amount <= 0) {
        document.getElementById("depositStatus").innerText = "Enter a valid amount.";
        return;
      }
      const user = users[currentUser];
      let bonus = amount * 0.25;
      user.wallet += amount + bonus;
      user.usedPhysicalDeposit = true;
      document.getElementById("walletBalance").innerText = user.wallet.toFixed(2);
      document.getElementById("depositStatus").innerText = `Deposited KES ${(amount + bonus).toFixed(2)} (25% bonus added)`;
      document.getElementById("depositAmount").value = "";
    }

    function saveBankCard() {
      const card = document.getElementById("bankCardNumber").value;
      if (!card) {
        document.getElementById("cardStatus").innerText = "Enter a card number.";
        return;
      }
      users[currentUser].linkedCard = card;
      document.getElementById("cardStatus").innerText = "Card linked successfully.";
      document.getElementById("bankCardNumber").value = "";
    }

    function sendToBank() {
      const account = document.getElementById("bankAccountNumber").value;
      const amount = parseFloat(document.getElementById("bankAmount").value);
      const pin = document.getElementById("bankPin").value;
      const user = users[currentUser];

      if (!account || isNaN(amount) || amount <= 0 || pin !== user.pin) {
        document.getElementById("bankStatus").innerText = "Invalid input or incorrect PIN.";
        return;
      }

      if (user.wallet < amount) {
        document.getElementById("bankStatus").innerText = "Insufficient funds.";
        return;
      }

      user.wallet -= amount;
      admin.tradingWallet += amount;

      document.getElementById("walletBalance").innerText = user.wallet.toFixed(2);
      document.getElementById("bankStatus").innerText = `Sent KES ${amount.toFixed(2)} to Bank Account ${account}`;

      document.getElementById("bankAccountNumber").value = "";
      document.getElementById("bankAmount").value = "";
      document.getElementById("bankPin").value = "";
    }

    function renderGraphs() {
      const userKeys = Object.keys(users);
      const transfers = userKeys.map(k => users[k].history.length);
      const charges = userKeys.map(k => users[k].charges);

      new Chart(document.getElementById("transferGraph"), {
        type: "bar",
        data: {
          labels: userKeys,
          datasets: [{
            label: "Transfers Made",
            data: transfers,
            backgroundColor: "blue"
          }]
        }
      });

      new Chart(document.getElementById("chargeGraph"), {
        type: "bar",
        data: {
          labels: userKeys,
          datasets: [{
            label: "Charges Collected",
            data: charges,
            backgroundColor: "green"
          }]
        }
      });
    }
  </script>
</body>
</html>
