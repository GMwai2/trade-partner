<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Trade Partner Wallet Demo</title>
<style>
  body { font-family: Arial, sans-serif; background: #f4f6f8; margin: 0; padding: 0; }
  header { background: #003366; color: white; padding: 1rem; text-align: center; }
  main { max-width: 800px; margin: 1rem auto; background: white; padding: 1rem; border-radius: 5px; box-shadow: 0 0 10px #aaa; }
  input, select, button { padding: 0.5rem; margin: 0.3rem 0; width: 100%; box-sizing: border-box; }
  button { background: #003366; color: white; border: none; cursor: pointer; }
  button:disabled { background: #aaa; cursor: not-allowed; }
  label { font-weight: bold; }
  .hidden { display: none; }
  .wallet-info { margin-bottom: 1rem; }
  .popup-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center;
  }
  .popup {
    background: white; padding: 1rem; border-radius: 5px; width: 300px;
  }
</style>
</head>
<body>
<header>
  <h1>Trade Partner Wallet Demo</h1>
</header>
<main>
  <section id="login-section">
    <h2>Login</h2>
    <label for="login-account">Account Number</label>
    <input type="text" id="login-account" autocomplete="off" />
    <label for="login-pin">PIN</label>
    <input type="password" id="login-pin" autocomplete="off" />
    <button id="login-btn">Login</button>
    <p id="login-error" style="color:red;"></p>
  </section>

  <section id="wallet-section" class="hidden">
    <div class="wallet-info">
      <p><strong>Account:</strong> <span id="user-account"></span></p>
      <p><strong>Balance (USD):</strong> $<span id="user-balance">0.00</span></p>
      <p><strong>Currency:</strong> <span id="user-currency">USD</span></p>
    </div>

    <h3>Transfer Funds</h3>
    <label for="transfer-account">Recipient Account Number</label>
    <input type="text" id="transfer-account" autocomplete="off" />
    
    <label for="transfer-amount">Amount</label>
    <input type="number" id="transfer-amount" min="0.01" step="0.01" />
    
    <label for="transfer-currency">Currency</label>
    <select id="transfer-currency">
      <option value="USD">USD</option>
      <option value="KES">KES</option>
      <option value="EUR">EUR</option>
    </select>
    
    <button id="transfer-btn" disabled>Initiate Transfer</button>

    <button id="logout-btn" style="margin-top: 1rem; background: #b22222;">Logout</button>
  </section>

  <!-- Confirmation Popup -->
  <div id="confirm-popup" class="popup-overlay hidden">
    <div class="popup">
      <h3>Confirm Transfer Details</h3>
      <p><strong>From:</strong> <span id="confirm-from"></span></p>
      <p><strong>To:</strong> <span id="confirm-to"></span></p>
      <p><strong>Amount:</strong> <span id="confirm-amount"></span></p>
      <p><strong>Currency:</strong> <span id="confirm-currency"></span></p>

      <label for="confirm-pin">Enter PIN to Authorize</label>
      <input type="password" id="confirm-pin" autocomplete="off" />
      <p id="confirm-error" style="color:red;"></p>
      
      <button id="confirm-btn">Confirm Transfer</button>
      <button id="cancel-btn" style="background:#aaa; color:#000;">Cancel</button>
    </div>
  </div>
</main>

<script>
// Basic simulated database in localStorage
const USERS_KEY = 'tradePartnerUsers';
const TRANSACTION_FEES_PERCENT = 0.005; // 0.5%
const TRANSACTION_FEES_MIN_AMOUNT = 250; // KES equivalent
const TRANSACTION_FEES_MAX = 1000; // max fee KES
const EXCHANGE_RATES = { // USD base for simplicity; KES and EUR are rough values
  USD: 1,
  KES: 0.0075, // 1 KES = 0.0075 USD
  EUR: 1.1,
};

// Initialize demo users if not present
function initializeUsers() {
  if (!localStorage.getItem(USERS_KEY)) {
    const demoUsers = {
      'user123': { pin: '1234', balance: 1000, currency: 'USD' },
      'user456': { pin: '4567', balance: 200000, currency: 'KES' },
      'admin': { pin: '0000', balance: 5000, currency: 'EUR', isAdmin: true, feesWallet: 0 },
    };
    localStorage.setItem(USERS_KEY, JSON.stringify(demoUsers));
  }
}

function getUsers() {
  return JSON.parse(localStorage.getItem(USERS_KEY));
}

function saveUsers(users) {
  localStorage.setItem(USERS_KEY, JSON.stringify(users));
}

let currentUser = null;

const loginSection = document.getElementById('login-section');
const walletSection = document.getElementById('wallet-section');
const loginAccountInput = document.getElementById('login-account');
const loginPinInput = document.getElementById('login-pin');
const loginBtn = document.getElementById('login-btn');
const loginError = document.getElementById('login-error');
const userAccountDisplay = document.getElementById('user-account');
const userBalanceDisplay = document.getElementById('user-balance');
const userCurrencyDisplay = document.getElementById('user-currency');
const logoutBtn = document.getElementById('logout-btn');

const transferAccountInput = document.getElementById('transfer-account');
const transferAmountInput = document.getElementById('transfer-amount');
const transferCurrencySelect = document.getElementById('transfer-currency');
const transferBtn = document.getElementById('transfer-btn');

const confirmPopup = document.getElementById('confirm-popup');
const confirmFrom = document.getElementById('confirm-from');
const confirmTo = document.getElementById('confirm-to');
const confirmAmount = document.getElementById('confirm-amount');
const confirmCurrency = document.getElementById('confirm-currency');
const confirmPinInput = document.getElementById('confirm-pin');
const confirmBtn = document.getElementById('confirm-btn');
const cancelBtn = document.getElementById('cancel-btn');
const confirmError = document.getElementById('confirm-error');

initializeUsers();

function login(account, pin) {
  const users = getUsers();
  if (users[account] && users[account].pin === pin) {
    currentUser = { account, ...users[account] };
    loginError.textContent = '';
    showWallet();
  } else {
    loginError.textContent = 'Invalid account or PIN.';
  }
}

function showWallet() {
  loginSection.classList.add('hidden');
  walletSection.classList.remove('hidden');
  userAccountDisplay.textContent = currentUser.account;
  userBalanceDisplay.textContent = currentUser.balance.toFixed(2);
  userCurrencyDisplay.textContent = currentUser.currency;
  transferBtn.disabled = true;
  clearTransferInputs();
}

function logout() {
  currentUser = null;
  loginSection.classList.remove('hidden');
  walletSection.classList.add('hidden');
  loginAccountInput.value = '';
  loginPinInput.value = '';
  loginError.textContent = '';
}

function clearTransferInputs() {
  transferAccountInput.value = '';
  transferAmountInput.value = '';
  transferCurrencySelect.value = currentUser.currency;
}

function isValidTransferInput() {
  return (
    transferAccountInput.value.trim() !== '' &&
    transferAmountInput.value > 0 &&
    transferCurrencySelect.value.trim() !== ''
  );
}

function convertCurrency(amount, fromCurrency, toCurrency) {
  const amountInUSD = amount * EXCHANGE_RATES[fromCurrency];
  return amountInUSD / EXCHANGE_RATES[toCurrency];
}

function calculateFee(amountInKES) {
  if (amountInKES < TRANSACTION_FEES_MIN_AMOUNT) return 0;
  const fee = amountInKES * TRANSACTION_FEES_PERCENT;
  return fee > TRANSACTION_FEES_MAX ? TRANSACTION_FEES_MAX : fee;
}

function enableTransferButton() {
  transferBtn.disabled = !isValidTransferInput();
}

function openConfirmationPopup() {
  confirmFrom.textContent = currentUser.account;
  confirmTo.textContent = transferAccountInput.value.trim();
  confirmAmount.textContent = Number(transferAmountInput.value).toFixed(2);
  confirmCurrency.textContent = transferCurrencySelect.value;
  confirmPinInput.value = '';
  confirmError.textContent = '';
  confirmPopup.classList.remove('hidden');
}

function closeConfirmationPopup() {
  confirmPopup.classList.add('hidden');
}

function performTransfer() {
  const recipientAccount = transferAccountInput.value.trim();
  const amount = Number(transferAmountInput.value);
  const currency = transferCurrencySelect.value;

  if (recipientAccount === currentUser.account) {
    confirmError.textContent = "Cannot transfer to your own account.";
    return;
  }

  const users = getUsers();

  if (!users[recipientAccount]) {
    confirmError.textContent = "Recipient account not found.";
    return;
  }

  const feeKES = calculateFee(convertCurrency(amount, currency, 'KES'));
  const feeUSD = convertCurrency(feeKES, 'KES', 'USD');

  // Convert transfer amount to user's currency for balance check
  const amountInUserCurrency = convertCurrency(amount, currency, currentUser.currency);

  if (currentUser.balance < amountInUserCurrency + feeUSD) {
    confirmError.textContent = "Insufficient balance including fees.";
    return;
  }

  // Validate PIN entered in confirmation popup
  if (confirmPinInput.value !== currentUser.pin) {
    confirmError.textContent = "Invalid PIN.";
    return;
  }

  // Deduct from sender
  users[currentUser.account].balance -= amountInUserCurrency + feeUSD;

  // Credit recipient in their currency converted from transfer currency
  const amountInRecipientCurrency = convertCurrency(amount, currency, users[recipientAccount].currency);
  users[recipientAccount].balance += amountInRecipientCurrency;

  // Credit fee to admin's fees wallet (converted to EUR)
  const feeInEUR = convertCurrency(feeKES, 'KES', 'EUR');
  users['admin'].feesWallet = (users['admin'].feesWallet || 0) + feeInEUR;

  saveUsers(users);

  // Update currentUser balance in-memory and UI
  currentUser.balance = users[currentUser.account].balance;
  userBalanceDisplay.textContent = currentUser.balance.toFixed(2);

  alert(`Transfer successful. Fees applied: KES ${feeKES.toFixed(2)} (converted)`);

  closeConfirmationPopup();
  clearTransferInputs();
  transferBtn.disabled = true;
}

loginBtn.addEventListener('click', () => {
  login(loginAccountInput.value.trim(), loginPinInput.value.trim());
});

logoutBtn.addEventListener('click', () => {
  logout();
});

transferAccountInput.addEventListener('input', enableTransferButton);
transferAmountInput.addEventListener('input', enableTransferButton);
transferCurrencySelect.addEventListener('change', enableTransferButton);

transferBtn.addEventListener('click', () => {
  openConfirmationPopup();
});

cancelBtn.addEventListener('click', () => {
  closeConfirmationPopup();
});

confirmBtn.addEventListener('click', () => {
  performTransfer();
});
</script>
</body>
</html>
