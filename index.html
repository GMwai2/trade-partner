<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Wallet Platform</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial; padding: 20px; }
    .hidden { display: none; }
    .panel { border: 1px solid #ccc; padding: 15px; margin: 10px 0; }
    .admin-only { background-color: #f0f0f0; }
  </style>
</head>
<body>

<h2>Multi-Currency Wallet Platform</h2>

<!-- Login/Register Section -->
<div id="auth-section">
  <h3>Register</h3>
  <input id="reg-username" placeholder="Username" />
  <input id="reg-password" placeholder="Password" type="password" />
  <select id="reg-country"></select>
  <select id="reg-role">
    <option value="user">User</option>
    <option value="sub-admin">Sub-Admin</option>
    <option value="admin">Admin</option>
  </select>
  <button onclick="register()">Register</button>

  <h3>Login</h3>
  <input id="login-username" placeholder="Username" />
  <input id="login-password" placeholder="Password" type="password" />
  <button onclick="login()">Login</button>
</div>

<!-- Main App Section -->
<div id="app-section" class="hidden">
  <h3>Welcome, <span id="user-label"></span>!</h3>
  <button onclick="logout()">Logout</button>

  <div class="panel">
    <h4>Your Wallets</h4>
    <div id="wallet-balances"></div>

    <h4>Send Money</h4>
    <select id="send-to"></select>
    <input id="send-amount" placeholder="Amount" type="number" />
    <select id="send-currency"></select>
    <button onclick="sendMoney()">Send</button>
  </div>

  <div id="admin-section" class="hidden panel admin-only">
    <h4>Admin Wallet (EUR only)</h4>
    <p>Transaction Wallet: <span id="admin-transaction-wallet"></span> EUR</p>
    <p>Trading Wallet: <span id="admin-trading-wallet"></span> EUR</p>
    <input id="admin-transfer-amount" type="number" placeholder="Amount to Transfer to Trading" />
    <button onclick="transferToTrading()">Transfer to Trading Wallet</button>
  </div>

  <div class="panel">
    <h4>Transaction History</h4>
    <div id="tx-history"></div>
  </div>

  <div class="panel">
    <h4>Performance Chart</h4>
    <canvas id="chart" width="400" height="200"></canvas>
  </div>
</div>

<script>
const users = {};
const exchangeRates = { USD: 1, EUR: 0.92, KES: 115, BTC: 0.000021 };
const countries = ["Kenya", "USA", "Germany", "India", "Brazil", "UK", "China", "Japan", "UAE", "South Africa"];
const countryDropdown = document.getElementById('reg-country');
countries.forEach(c => {
  const option = document.createElement("option");
  option.text = c;
  option.value = c;
  countryDropdown.add(option);
});

let currentUser = null;
let chart;

function register() {
  const username = document.getElementById("reg-username").value;
  const password = document.getElementById("reg-password").value;
  const country = document.getElementById("reg-country").value;
  const role = document.getElementById("reg-role").value;

  if (users[username]) return alert("User exists");

  users[username] = {
    username, password, country, role,
    wallets: { USD: 1000, EUR: 500, KES: 10000, BTC: 0.05 },
    txWallet: 0,
    tradingWallet: 0,
    transactions: []
  };
  alert("Registered");
}

function login() {
  const username = document.getElementById("login-username").value;
  const password = document.getElementById("login-password").value;

  if (!users[username] || users[username].password !== password) return alert("Invalid login");

  currentUser = users[username];
  document.getElementById("auth-section").classList.add("hidden");
  document.getElementById("app-section").classList.remove("hidden");
  document.getElementById("user-label").innerText = username;
  document.getElementById("admin-section").classList.toggle("hidden", currentUser.role !== "admin");
  updateUI();
}

function logout() {
  currentUser = null;
  document.getElementById("auth-section").classList.remove("hidden");
  document.getElementById("app-section").classList.add("hidden");
}

function updateUI() {
  const walletsDiv = document.getElementById("wallet-balances");
  walletsDiv.innerHTML = Object.entries(currentUser.wallets).map(
    ([cur, bal]) => `<p>${cur}: ${bal.toFixed(2)}</p>`).join("");

  const userOptions = Object.values(users).filter(u => u !== currentUser).map(
    u => `<option value="${u.username}">${u.username}</option>`).join("");
  document.getElementById("send-to").innerHTML = userOptions;

  const currencies = Object.keys(exchangeRates);
  document.getElementById("send-currency").innerHTML = currencies.map(c => `<option value="${c}">${c}</option>`).join("");

  const txDiv = document.getElementById("tx-history");
  txDiv.innerHTML = currentUser.transactions.slice(-5).reverse().map(t => `<p>${t}</p>`).join("");

  if (currentUser.role === "admin") {
    document.getElementById("admin-transaction-wallet").innerText = currentUser.txWallet.toFixed(2);
    document.getElementById("admin-trading-wallet").innerText = currentUser.tradingWallet.toFixed(2);
  }

  updateChart();
}

function sendMoney() {
  const toUser = document.getElementById("send-to").value;
  const amount = parseFloat(document.getElementById("send-amount").value);
  const currency = document.getElementById("send-currency").value;

  if (!toUser || isNaN(amount) || amount <= 0) return alert("Invalid input");
  if (currentUser.wallets[currency] < amount) return alert("Insufficient funds");

  const baseKES = amount * (1 / exchangeRates.KES) * exchangeRates[currency];
  let fee = baseKES >= 250 ? 0.005 * amount : 0;
  if (fee > 1000 / exchangeRates[currency]) fee = 1000 / exchangeRates[currency];

  const netAmount = amount - fee;
  currentUser.wallets[currency] -= amount;

  const recipient = users[toUser];
  recipient.wallets[currency] = (recipient.wallets[currency] || 0) + netAmount;

  const admin = Object.values(users).find(u => u.role === "admin");
  if (admin) {
    const feeInEUR = fee * exchangeRates[currency] / exchangeRates.EUR;
    admin.txWallet += feeInEUR;
  }

  const txNote = `${currency} ${amount} sent to ${toUser}, Fee: ${fee.toFixed(2)} ${currency}`;
  currentUser.transactions.push(txNote);
  recipient.transactions.push(`Received ${currency} ${netAmount.toFixed(2)} from ${currentUser.username}`);

  updateUI();
}

function transferToTrading() {
  const amount = parseFloat(document.getElementById("admin-transfer-amount").value);
  if (isNaN(amount) || amount <= 0 || amount > currentUser.txWallet) return alert("Invalid");

  currentUser.txWallet -= amount;
  currentUser.tradingWallet += amount;
  updateUI();
}

function updateChart() {
  const tx = currentUser.transactions;
  const summary = {};
  tx.forEach(entry => {
    const match = entry.match(/([A-Z]{3}) (\d+(\.\d+)?)/);
    if (match) {
      const [_, cur, amt] = match;
      summary[cur] = (summary[cur] || 0) + parseFloat(amt);
    }
  });

  const labels = Object.keys(summary);
  const data = Object.values(summary);

  if (chart) chart.destroy();
  chart = new Chart(document.getElementById("chart"), {
    type: 'bar',
    data: {
      labels,
      datasets: [{ label: 'Currency Activity', data, backgroundColor: 'rgba(54, 162, 235, 0.6)' }]
    },
    options: { responsive: true, scales: { y: { beginAtZero: true } } }
  });
}
</script>
</body>
</html>
