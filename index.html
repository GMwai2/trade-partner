<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Wallet Demo - Cross-Currency Transfer with PIN</title>
<style>
  body { font-family: Arial, sans-serif; max-width: 800px; margin: 20px auto; }
  h1 { text-align: center; }
  label { display: block; margin: 10px 0 5px; }
  input, select, button { padding: 8px; font-size: 1rem; width: 100%; max-width: 300px; }
  .wallet-balance { margin-bottom: 20px; }
  .transaction-log { margin-top: 30px; }
  table { width: 100%; border-collapse: collapse; margin-top: 10px; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
  th { background: #eee; }
  #confirmPopup {
    position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
    background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center;
  }
  #confirmBox {
    background: white; padding: 20px; border-radius: 5px; width: 300px;
  }
  #confirmBox button { margin: 10px 5px 0 0; }
  .error { color: red; }
  .success { color: green; }
</style>
</head>
<body>

<h1>Wallet Demo: Cross-Currency Transfer</h1>

<div class="wallet-balance">
  <h2>Your Wallet Balances</h2>
  <ul id="balancesList"></ul>
</div>

<div class="transfer-form">
  <h2>Send Money</h2>
  <label for="senderCurrency">Your Currency:</label>
  <select id="senderCurrency"></select>

  <label for="recipientAccount">Recipient Account Number:</label>
  <input type="text" id="recipientAccount" placeholder="e.g. 1234567890" />

  <label for="recipientName">Recipient Name:</label>
  <input type="text" id="recipientName" placeholder="e.g. John Doe" />

  <label for="recipientCurrency">Recipient Currency:</label>
  <select id="recipientCurrency"></select>

  <label for="amount">Amount to Send:</label>
  <input type="number" id="amount" min="0.01" step="0.01" />

  <button id="sendBtn">Send</button>
  <p id="formError" class="error"></p>
</div>

<div id="confirmPopup">
  <div id="confirmBox">
    <h3>Confirm Transfer</h3>
    <p id="confirmDetails"></p>
    <label for="pinInput">Enter your PIN to authorize:</label>
    <input type="password" id="pinInput" maxlength="6" placeholder="6-digit PIN" />
    <p id="pinError" class="error"></p>
    <button id="confirmBtn">Confirm</button>
    <button id="cancelBtn">Cancel</button>
  </div>
</div>

<div class="transaction-log">
  <h2>Transaction Log</h2>
  <table>
    <thead>
      <tr><th>Date & Time</th><th>From</th><th>To</th><th>Amount Sent</th><th>Amount Received</th><th>Status</th></tr>
    </thead>
    <tbody id="transactionTableBody"></tbody>
  </table>
</div>

<script>
// === Demo Data ===
// Simulated wallet balances stored locally
const walletBalances = {
  USD: 1000.00,
  EUR: 800.00,
  KES: 50000.00,
  GBP: 700.00,
};

// Hardcoded exchange rates to USD for demo (1 unit of currency = ? USD)
const exchangeRatesToUSD = {
  USD: 1,
  EUR: 1.1,
  KES: 0.0075,
  GBP: 1.25,
};

// User's PIN for demo authorization (hashed or encrypted PIN should be used in real app)
const USER_PIN = "123456";

// Populate currency dropdowns
function populateCurrencyDropdowns() {
  const senderCur = document.getElementById('senderCurrency');
  const recipientCur = document.getElementById('recipientCurrency');
  senderCur.innerHTML = '';
  recipientCur.innerHTML = '';
  for (const cur of Object.keys(walletBalances)) {
    const option1 = document.createElement('option');
    option1.value = cur;
    option1.textContent = cur;
    senderCur.appendChild(option1);

    const option2 = document.createElement('option');
    option2.value = cur;
    option2.textContent = cur;
    recipientCur.appendChild(option2);
  }
}
populateCurrencyDropdowns();

// Display wallet balances
function displayBalances() {
  const list = document.getElementById('balancesList');
  list.innerHTML = '';
  for (const [cur, bal] of Object.entries(walletBalances)) {
    const li = document.createElement('li');
    li.textContent = `${cur}: ${bal.toFixed(2)}`;
    list.appendChild(li);
  }
}
displayBalances();

let pendingTransfer = null;
let transactions = [];

// Calculate exchange rate sender -> recipient
function getExchangeRate(senderCur, recipientCur) {
  // Convert sender to USD, then USD to recipient
  const toUSD = exchangeRatesToUSD[senderCur];
  const fromUSD = 1 / exchangeRatesToUSD[recipientCur];
  return toUSD * fromUSD;
}

// Calculate fee (0.5% for >= KES 250 equivalent, max KES 1000 equivalent)
function calculateFee(amountInKES) {
  if (amountInKES < 250) return 0;
  let fee = amountInKES * 0.005;
  if (fee > 1000) fee = 1000;
  return fee;
}

function convertToKES(amount, currency) {
  return amount * exchangeRatesToUSD[currency] / exchangeRatesToUSD['KES'];
}

// Show error message
function showError(message) {
  const err = document.getElementById('formError');
  err.textContent = message;
}

// Clear error
function clearError() {
  const err = document.getElementById('formError');
  err.textContent = '';
}

// Clear PIN error
function clearPinError() {
  const err = document.getElementById('pinError');
  err.textContent = '';
}

document.getElementById('sendBtn').addEventListener('click', () => {
  clearError();
  clearPinError();

  const senderCur = document.getElementById('senderCurrency').value;
  const recipientAcc = document.getElementById('recipientAccount').value.trim();
  const recipientName = document.getElementById('recipientName').value.trim();
  const recipientCur = document.getElementById('recipientCurrency').value;
  const amountStr = document.getElementById('amount').value.trim();
  const amount = parseFloat(amountStr);

  if (!recipientAcc) {
    showError('Recipient account number is required.');
    return;
  }
  if (!recipientName) {
    showError('Recipient name is required.');
    return;
  }
  if (!amount || amount <= 0) {
    showError('Please enter a valid amount.');
    return;
  }
  if (senderCur === recipientCur && walletBalances[senderCur] < amount) {
    showError(`Insufficient funds. Your ${senderCur} balance is ${walletBalances[senderCur].toFixed(2)}.`);
    return;
  }
  if (senderCur !== recipientCur) {
    // Convert to sender currency to check balance
    if (walletBalances[senderCur] < amount) {
      showError(`Insufficient funds. Your ${senderCur} balance is ${walletBalances[senderCur].toFixed(2)}.`);
      return;
    }
  }

  // Calculate fee in KES
  const amountInKES = convertToKES(amount, senderCur);
  const feeKES = calculateFee(amountInKES);
  const feeSenderCur = feeKES * exchangeRatesToUSD['KES'] / exchangeRatesToUSD[senderCur];

  if ((amount + feeSenderCur) > walletBalances[senderCur]) {
    showError(`Insufficient funds to cover amount plus fee (fee approx ${feeSenderCur.toFixed(2)} ${senderCur}).`);
    return;
  }

  // Calculate amount recipient receives
  const rate = getExchangeRate(senderCur, recipientCur);
  const amountReceived = amount * rate;

  // Show confirm popup
  pendingTransfer = {
    senderCur, recipientAcc, recipientName, recipientCur,
    amount, amountReceived, feeSenderCur, feeKES,
  };

  const confirmDetails = `
    <strong>From:</strong> You (${senderCur})<br/>
    <strong>To:</strong> ${recipientName} (${recipientAcc})<br/>
    <strong>Amount to Send:</strong> ${amount.toFixed(2)} ${senderCur}<br/>
    <strong>Transaction Fee:</strong> ${feeSenderCur.toFixed(2)} ${senderCur}<br/>
    <strong>Amount Recipient Gets:</strong> ${amountReceived.toFixed(2)} ${recipientCur}<br/>
  `;
  document.getElementById('confirmDetails').innerHTML = confirmDetails;
  document.getElementById('pinInput').value = '';
  document.getElementById('pinError').textContent = '';

  document.getElementById('confirmPopup').style.display = 'flex';
});

// Cancel transfer
document.getElementById('cancelBtn').addEventListener('click', () => {
  document.getElementById('confirmPopup').style.display = 'none';
  pendingTransfer = null;
});

// Confirm transfer with PIN
document.getElementById('confirmBtn').addEventListener('click', () => {
  const pin = document.getElementById('pinInput').value.trim();
  if (!pin) {
    document.getElementById('pinError').textContent = 'PIN is required.';
    return;
  }
  if (pin !== USER_PIN) {
    document.getElementById('pinError').textContent = 'Incorrect PIN.';
    return;
  }
  if (!pendingTransfer) return;

  // Deduct amount + fee from sender
  walletBalances[pendingTransfer.senderCur] -= (pendingTransfer.amount + pendingTransfer.feeSenderCur);

  // Credit amountReceived to recipient currency (simulate - if recipient currency is user's wallet, add; else no effect)
  if (walletBalances[pendingTransfer.recipientCur] !== undefined) {
    walletBalances[pendingTransfer.recipientCur] += pendingTransfer.amountReceived;
  }
  displayBalances();

  // Add transaction to log
  transactions.unshift({
    datetime: new Date().toLocaleString(),
    from: `You (${pendingTransfer.senderCur})`,
    to: `${pendingTransfer.recipientName} (${pendingTransfer.recipientAcc})`,
    amountSent: `${pendingTransfer.amount.toFixed(2)} ${pendingTransfer.senderCur}`,
    amountReceived: `${pendingTransfer.amountReceived.toFixed(2)} ${pendingTransfer.recipientCur}`,
    status: 'Success',
  });
  renderTransactions();

  // Clear pending transfer and close popup
  pendingTransfer = null;
  document.getElementById('confirmPopup').style.display = 'none';

  alert('Transfer successful.');
});

// Render transaction log
function renderTransactions() {
  const tbody = document.getElementById('transactionTableBody');
  tbody.innerHTML = '';
  for (const tx of transactions) {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${tx.datetime}</td>
      <td>${tx.from}</td>
      <td>${tx.to}</td>
      <td>${tx.amountSent}</td>
      <td>${tx.amountReceived}</td>
      <td>${tx.status}</td>
    `;
    tbody.appendChild(tr);
  }
}
</script>

</body>
</html>
