<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Wallet Platform</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f0f2f5; }
    h2 { margin-top: 0; }
    .hidden { display: none; }
    input, select, button { margin: 5px 0; padding: 8px; width: 100%; max-width: 300px; }
    label { display: block; margin-top: 10px; font-weight: bold; }
    #dashboard, #adminDashboard, #transactionHistory, #registerSection, #otpSection { margin-top: 20px; background: white; padding: 20px; border-radius: 5px; }
    #messages { color: green; margin-bottom: 10px; }
    #errors { color: red; margin-bottom: 10px; }
    canvas { max-width: 600px; margin: 10px 0; }
    table { border-collapse: collapse; width: 100%; max-width: 800px; margin-top: 10px; }
    th, td { border: 1px solid #ddd; padding: 8px; }
    th { background: #333; color: white; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<h1>Wallet Platform</h1>
<div id="messages"></div>
<div id="errors"></div>

<!-- Authentication -->
<div id="authSection">
  <h2>Login</h2>
  <label for="loginUsername">Username or Email</label>
  <input type="text" id="loginUsername" placeholder="Username or Email" />
  <label for="loginPassword">Password</label>
  <input type="password" id="loginPassword" placeholder="Password" />
  <button onclick="login()">Login</button>
  <p>Don't have an account? <a href="#" onclick="showRegister()">Register here</a></p>
</div>

<!-- Registration -->
<div id="registerSection" class="hidden">
  <h2>Register</h2>
  <label for="surname">Surname</label>
  <input type="text" id="surname" placeholder="Surname" />
  <label for="middleName">Middle Name (optional)</label>
  <input type="text" id="middleName" placeholder="Middle Name" />
  <label for="firstName">First Name</label>
  <input type="text" id="firstName" placeholder="First Name" />
  <label for="idNumber">ID/Passport Number</label>
  <input type="text" id="idNumber" placeholder="ID or Passport" />
  <label for="phone">Phone Number</label>
  <input type="text" id="phone" placeholder="Phone Number" />
  <label for="email">Email</label>
  <input type="email" id="email" placeholder="Email Address" />
  <label for="regPassword">Password</label>
  <input type="password" id="regPassword" placeholder="Password" />
  <label for="pin">4-digit PIN</label>
  <input type="password" id="pin" maxlength="4" placeholder="PIN" />
  <label for="idUpload">Upload ID</label>
  <input type="file" id="idUpload" />
  <label for="selfieUpload">Upload Selfie</label>
  <input type="file" id="selfieUpload" />
  <button onclick="initiateOTP()">Register</button>
</div>

<!-- OTP Verification -->
<div id="otpSection" class="hidden">
  <h2>Verify OTP</h2>
  <p>A verification code has been sent to your phone and email.</p>
  <label for="otpCode">Enter OTP Code</label>
  <input type="text" id="otpCode" />
  <button onclick="verifyOTP()">Verify & Complete Registration</button>
</div>
<script>
const USERS_KEY = 'walletUsers';
const LOGGED_IN_KEY = 'walletLoggedInUser';
const OTP_TEMP = '123456'; // Simulated OTP for now

const hardcodedAdmin = {
  username: 'admin',
  password: 'Admin@123',
  email: 'admin@example.com',
  phone: '0000000000',
  surname: 'Admin',
  middleName: '',
  firstName: 'User',
  idNumber: 'ADMIN001',
  pin: '0000',
  wallets: { transaction: 1000000, trading: 500000 },
  isAdmin: true,
  walletNumber: 'ADMINWALLET0001'
};

let tempUser = null;

// Utilities
function generateWalletNumber(id) {
  const rand = Math.floor(1000 + Math.random() * 9000);
  return `WALLET${id}${rand}`;
}

function saveUser(user) {
  let users = JSON.parse(localStorage.getItem(USERS_KEY)) || [];
  const existingIndex = users.findIndex(u => u.username === user.username);
  if (existingIndex > -1) {
    users[existingIndex] = user;
  } else {
    users.push(user);
  }
  localStorage.setItem(USERS_KEY, JSON.stringify(users));
}

function showRegister() {
  document.getElementById('authSection').classList.add('hidden');
  document.getElementById('registerSection').classList.remove('hidden');
}

// Step 1: Collect data, trigger OTP
function initiateOTP() {
  const user = {
    surname: document.getElementById('surname').value.trim(),
    middleName: document.getElementById('middleName').value.trim(),
    firstName: document.getElementById('firstName').value.trim(),
    idNumber: document.getElementById('idNumber').value.trim(),
    phone: document.getElementById('phone').value.trim(),
    email: document.getElementById('email').value.trim(),
    password: document.getElementById('regPassword').value.trim(),
    pin: document.getElementById('pin').value.trim(),
    isAdmin: false,
    wallets: { transaction: 0, trading: 0 },
    idUpload: document.getElementById('idUpload').files[0]?.name || '',
    selfieUpload: document.getElementById('selfieUpload').files[0]?.name || '',
    walletNumber: '',
    username: ''
  };

  if (!user.surname || !user.firstName || !user.idNumber || !user.phone || !user.email || !user.password || !user.pin) {
    showError('Please fill in all required fields.');
    return;
  }

  user.username = user.idNumber;
  user.walletNumber = generateWalletNumber(user.idNumber);
  tempUser = user;

  document.getElementById('registerSection').classList.add('hidden');
  document.getElementById('otpSection').classList.remove('hidden');

  showMessage(`Simulated OTP sent: ${OTP_TEMP}`);
}

// Step 2: Verify OTP and complete registration
function verifyOTP() {
  const code = document.getElementById('otpCode').value.trim();
  if (code !== OTP_TEMP) {
    showError('Incorrect OTP.');
    return;
  }

  if (tempUser) {
    saveUser(tempUser);
    showMessage('Registration complete. You can now log in.');
    document.getElementById('otpSection').classList.add('hidden');
    document.getElementById('authSection').classList.remove('hidden');
  }
}

// Login
function login() {
  const username = document.getElementById('loginUsername').value.trim();
  const password = document.getElementById('loginPassword').value.trim();
  let users = JSON.parse(localStorage.getItem(USERS_KEY)) || [];

  if (username === hardcodedAdmin.username && password === hardcodedAdmin.password) {
    saveUser(hardcodedAdmin);
    localStorage.setItem(LOGGED_IN_KEY, JSON.stringify(hardcodedAdmin));
    showAdminDashboard();
    return;
  }

  const user = users.find(u =>
    (u.username === username || u.email === username) && u.password === password
  );

  if (!user) {
    showError('Invalid username or password.');
    return;
  }

  localStorage.setItem(LOGGED_IN_KEY, JSON.stringify(user));
  if (user.isAdmin) {
    showAdminDashboard();
  } else {
    showUserDashboard(user);
  }
}

function logout() {
  localStorage.removeItem(LOGGED_IN_KEY);
  location.reload();
}

function showError(message) {
  document.getElementById('errors').textContent = message;
  document.getElementById('messages').textContent = '';
}

function showMessage(message) {
  document.getElementById('messages').textContent = message;
  document.getElementById('errors').textContent = '';
}

function showAdminDashboard() {
  document.getElementById('authSection').classList.add('hidden');
  document.getElementById('adminDashboard')?.classList.remove('hidden');
  renderAdminGraphs();
}

function renderAdminGraphs() {
  let users = JSON.parse(localStorage.getItem(USERS_KEY)) || [];
  users = [hardcodedAdmin, ...users.filter(u => u.username !== 'admin')];

  const labels = users.map(u => u.username);
  const transactionData = users.map(u => u.wallets.transaction || 0);
  const tradingData = users.map(u => u.wallets.trading || 0);

  document.getElementById('adminTransactionWalletTotal').textContent = transactionData.reduce((a,b) => a+b, 0).toLocaleString();
  document.getElementById('adminTradingWalletTotal').textContent = tradingData.reduce((a,b) => a+b, 0).toLocaleString();

  new Chart(document.getElementById('transactionWalletChart'), {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: 'Transaction Wallets',
        backgroundColor: '#4caf50',
        data: transactionData
      }]
    }
  });

  new Chart(document.getElementById('tradingWalletChart'), {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: 'Trading Wallets',
        backgroundColor: '#2196f3',
        data: tradingData
      }]
    }
  });
}

// Auto-login if session is active
window.onload = () => {
  const user = JSON.parse(localStorage.getItem(LOGGED_IN_KEY));
  if (user?.isAdmin) {
    showAdminDashboard();
  } else if (user) {
    showUserDashboard(user);
  }
};

function showUserDashboard(user) {
  alert(`Welcome ${user.firstName}! Dashboard coming soon.`);
}
</script>
</body>
</html>
