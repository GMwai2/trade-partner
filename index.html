<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Wallet Platform</title>
  <style>
    body { font-family: Arial; margin: 20px; }
    .hidden { display: none; }
    .dashboard, #transferSection, #logoutBtn, #adminGraphs { margin-top: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background: #eee; }
  </style>
</head>
<body>
  <h2>Wallet Platform</h2>

  <div id="loginSection">
    <h3>Login</h3>
    <input id="loginUsername" placeholder="Username"><br>
    <input id="loginPassword" type="password" placeholder="Password"><br>
    <button onclick="login()">Login</button>
    <p id="loginError" style="color:red;"></p>
  </div>

  <button id="logoutBtn" class="hidden" onclick="logout()">Logout</button>

  <div id="userDashboard" class="dashboard hidden">
    <h3>Welcome, <span id="userName"></span></h3>
    <p>Wallet: <span id="walletBalance"></span> KES</p>
    <p>Charges Wallet: <span id="chargeWalletBalance"></span> KES</p>

    <div id="transferSection">
      <h4>Transfer Money</h4>
      <input id="recipientWallet" placeholder="Recipient Wallet" onblur="showRecipientInfo()"><br>
      <p id="recipientInfo" style="color:gray;"></p>
      <input id="amountToSend" type="number" placeholder="Amount"><br>
      <input id="authPin" type="password" placeholder="Authorization PIN"><br>
      <button onclick="initiateTransfer()">Send</button>
      <p id="transferStatus" style="color:green;"></p>
    </div>

    <h4>Transaction History</h4>
    <table id="transactionTable">
      <thead><tr><th>Date</th><th>To</th><th>Amount</th><th>Charge</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="adminDashboard" class="dashboard hidden">
    <h3>Welcome, Admin</h3>
    <p>Admin Trading Wallet: <span id="adminTradingWallet"></span> KES</p>
    <p>Admin Charge Wallet: <span id="adminChargeWallet"></span> KES</p>

    <div id="adminGraphs">
      <h4>Graph: Total Transfers</h4>
      <canvas id="transferGraph" width="400" height="200"></canvas>
      <h4>Graph: Charges Collected</h4>
      <canvas id="chargeGraph" width="400" height="200"></canvas>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const users = {
      kilush: { password: "pass123", pin: "1234", wallet: 10000, charges: 0, email: "kilush@email.com", history: [] },
      schwadz: { password: "pass123", pin: "5678", wallet: 8000, charges: 0, email: "schwadz@email.com", history: [] }
    };

    let admin = {
      username: "admin",
      password: "admin123",
      tradingWallet: 0,
      chargeWallet: 0
    };

    let currentUser = null;

    function login() {
      const uname = document.getElementById("loginUsername").value;
      const pass = document.getElementById("loginPassword").value;
      document.getElementById("loginError").innerText = "";

      if (uname === admin.username && pass === admin.password) {
        currentUser = "admin";
        showAdminDashboard();
      } else if (users[uname] && users[uname].password === pass) {
        currentUser = uname;
        showUserDashboard();
      } else {
        document.getElementById("loginError").innerText = "Invalid credentials.";
      }
    }

    function showUserDashboard() {
      document.getElementById("loginSection").classList.add("hidden");
      document.getElementById("logoutBtn").classList.remove("hidden");
      document.getElementById("userDashboard").classList.remove("hidden");

      const user = users[currentUser];
      document.getElementById("userName").innerText = currentUser;
      document.getElementById("walletBalance").innerText = user.wallet.toFixed(2);
      document.getElementById("chargeWalletBalance").innerText = user.charges.toFixed(2);

      loadTransactionHistory(currentUser);
    }

    function showAdminDashboard() {
      document.getElementById("loginSection").classList.add("hidden");
      document.getElementById("logoutBtn").classList.remove("hidden");
      document.getElementById("adminDashboard").classList.remove("hidden");

      document.getElementById("adminTradingWallet").innerText = admin.tradingWallet.toFixed(2);
      document.getElementById("adminChargeWallet").innerText = admin.chargeWallet.toFixed(2);

      renderGraphs();
    }

    function logout() {
      currentUser = null;
      location.reload();
    }

    function showRecipientInfo() {
      const recipientWallet = document.getElementById("recipientWallet").value;
      const infoBox = document.getElementById("recipientInfo");
      if (users[recipientWallet]) {
        infoBox.innerText = `Recipient found: ${recipientWallet}`;
      } else {
        infoBox.innerText = "Recipient not found.";
      }
    }

    function initiateTransfer() {
      const recipientWallet = document.getElementById("recipientWallet").value;
      const amount = parseFloat(document.getElementById("amountToSend").value);
      const pin = document.getElementById("authPin").value;
      const sender = users[currentUser];

      document.getElementById("transferStatus").innerText = "";

      if (!users[recipientWallet]) {
        alert("Recipient wallet not found.");
        return;
      }

      if (recipientWallet === currentUser) {
        alert("Cannot send to yourself.");
        return;
      }

      if (isNaN(amount) || amount <= 0) {
        alert("Enter a valid amount.");
        return;
      }

      if (pin !== sender.pin) {
        alert("Incorrect PIN.");
        return;
      }

      // Prevent duplicate transfer within 1 minute
      const now = new Date();
      const lastTx = sender.history[sender.history.length - 1];
      if (
        lastTx &&
        lastTx.to === recipientWallet &&
        lastTx.amount === amount &&
        now - new Date(lastTx.date) < 60000
      ) {
        alert("Duplicate transfer detected within 1 minute.");
        return;
      }

      // Charge logic
      let charge = 0;
      if (amount > 250) {
        charge = Math.min(amount * 0.01, 1000);
      }

      const totalDebit = amount + charge;
      if (sender.wallet < totalDebit) {
        alert("Insufficient balance.");
        return;
      }

      sender.wallet -= totalDebit;
      sender.charges += charge;
      users[recipientWallet].wallet += amount;

      // Record history
      const txTime = now.toLocaleString();
      sender.history.push({ date: txTime, to: recipientWallet, amount, charge });

      // Admin receives
      admin.tradingWallet += amount;
      admin.chargeWallet += charge;

      document.getElementById("walletBalance").innerText = sender.wallet.toFixed(2);
      document.getElementById("chargeWalletBalance").innerText = sender.charges.toFixed(2);
      document.getElementById("transferStatus").innerText = "Transfer complete.";

      // Clear input fields
      document.getElementById("recipientWallet").value = "";
      document.getElementById("amountToSend").value = "";
      document.getElementById("authPin").value = "";
      document.getElementById("recipientInfo").innerText = "";

      loadTransactionHistory(currentUser);
    }

    function loadTransactionHistory(userKey) {
      const table = document.getElementById("transactionTable").querySelector("tbody");
      table.innerHTML = "";
      users[userKey].history.forEach(tx => {
        const row = `<tr><td>${tx.date}</td><td>${tx.to}</td><td>${tx.amount}</td><td>${tx.charge}</td></tr>`;
        table.innerHTML += row;
      });
    }

    function renderGraphs() {
      const currencies = Object.keys(users);
      const transfers = currencies.map(u => users[u].history.reduce((s, tx) => s + tx.amount, 0));
      const charges = currencies.map(u => users[u].history.reduce((s, tx) => s + tx.charge, 0));

      new Chart(document.getElementById("transferGraph"), {
        type: 'bar',
        data: {
          labels: currencies,
          datasets: [{ label: 'Total Sent (KES)', data: transfers, backgroundColor: 'blue' }]
        }
      });

      new Chart(document.getElementById("chargeGraph"), {
        type: 'bar',
        data: {
          labels: currencies,
          datasets: [{ label: 'Total Charges (KES)', data: charges, backgroundColor: 'green' }]
        }
      });
    }
  </script>
</body>
</html>
