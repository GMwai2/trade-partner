<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Wallet Platform</title>
  <style>
    body { font-family: Arial; margin: 20px; }
    input, button, select { margin: 5px 0; padding: 8px; width: 100%; }
    .hidden { display: none; }
    .container { max-width: 500px; margin: auto; }
    .admin-section { background: #f3f3f3; padding: 10px; border: 1px solid #ccc; margin-top: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 6px; }
    button.export-btn { width: auto; margin: 5px 10px 10px 0; padding: 6px 12px; }
  </style>
</head>
<body>
<div class="container">
  <h2>Wallet Platform</h2>

  <!-- Start Page -->
  <div id="start-page">
    <button onclick="showPage('register')">Register</button>
    <button onclick="showPage('login')">Login</button>
  </div>

  <!-- Registration -->
  <div id="register" class="hidden">
    <h3>User Registration (KYC)</h3>
    <input id="surname" placeholder="Surname" />
    <input id="middlename" placeholder="Middle Name (optional)" />
    <input id="firstname" placeholder="First Name" />
    <input id="idno" placeholder="ID/Passport Number" />
    <input id="phone" placeholder="Phone Number" />
    <input id="email" placeholder="Email Address" />
    <input id="password" type="password" placeholder="Password" />
    <input id="pin" placeholder="PIN (4 digits)" />
    <button onclick="sendOTP()">Send OTP</button>
    <div id="otp-section" class="hidden">
      <input id="otp" placeholder="Enter OTP" />
      <button onclick="register()">Verify & Register</button>
    </div>
    <button onclick="showPage('start-page')">Back</button>
  </div>

  <!-- Login -->
  <div id="login" class="hidden">
    <h3>Login</h3>
    <input id="login-username" placeholder="Username" />
    <input id="login-password" type="password" placeholder="Password" />
    <button onclick="login()">Login</button>
    <button onclick="showPage('start-page')">Back</button>
  </div>

  <!-- Dashboard -->
  <div id="dashboard" class="hidden">
    <h3 id="welcome"></h3>
    <p>Wallet: <span id="wallet-number"></span> | Balance: <span id="wallet-balance"></span></p>
    <div id="transfer-form">
      <input id="recipient" placeholder="Recipient Wallet Number" />
      <input id="amount" type="number" placeholder="Amount to Send" />
      <input id="auth-pin" placeholder="Enter PIN to Authorize" />
      <button onclick="transferMoney()">Transfer</button>
    </div>
    <div>
      <h4>Top-Up Wallet</h4>
      <input id="topup-amount" type="number" placeholder="Amount" />
      <button onclick="topUp()">Top Up</button>
    </div>
    <div>
      <h4>Transaction History</h4>
      <ul id="history"></ul>
    </div>
    <button onclick="logout()">Logout</button>
  </div>

  <!-- Admin Panel -->
  <div id="admin-panel" class="hidden">
    <h3>Admin Dashboard</h3>
    <div>
      <p>Total Users: <span id="total-users"></span></p>
      <p>Total Charges Collected: <span id="total-charges"></span></p>
    </div>
    <div class="admin-section">
      <h4>User Data</h4>
      <button class="export-btn" onclick="exportUsersCSV()">Export Users to CSV</button>
      <table>
        <thead><tr><th>Wallet</th><th>Name</th><th>Email</th><th>Phone</th><th>Balance</th></tr></thead>
        <tbody id="admin-user-table"></tbody>
      </table>
    </div>
    <div class="admin-section">
      <h4>All Transactions</h4>
      <button class="export-btn" onclick="exportTransactionsCSV()">Export Transactions to CSV</button>
      <ul id="admin-history"></ul>
    </div>
    <button onclick="logout()">Logout</button>
  </div>
</div>

<script>
  let users = {
    'admin': { username: 'admin', password: 'admin123', role: 'admin' },
    'schwadz': { username: 'schwadz', password: 'pass123', balance: 10000, role: 'user', pin: '1234', wallet: 'W1001', name: 'Schwadz', email: 's@wallet.com', phone: '0712345678' }
  };
  let currentUser = null;
  let totalCharges = 0;
  let generatedOTP = '';
  let transactionLogs = [];

  function showPage(page) {
    document.querySelectorAll('.container > div').forEach(div => div.classList.add('hidden'));
    document.getElementById(page).classList.remove('hidden');
  }

  function sendOTP() {
    generatedOTP = Math.floor(100000 + Math.random() * 900000).toString();
    alert(`OTP sent: ${generatedOTP}`);
    document.getElementById('otp-section').classList.remove('hidden');
  }

  function register() {
    const id = document.getElementById('idno').value.trim();
    if(!id) return alert('ID/Passport number required');
    const username = 'U' + id;
    if (users[username]) return alert('User already registered with this ID/Passport');
    const fullName = `${document.getElementById('surname').value} ${document.getElementById('middlename').value} ${document.getElementById('firstname').value}`.trim();
    if(!fullName) return alert('Full name is required');
    const otp = document.getElementById('otp').value.trim();
    if (otp !== generatedOTP) return alert('Invalid OTP');
    const pwd = document.getElementById('password').value;
    if (!pwd) return alert('Password required');
    const pin = document.getElementById('pin').value;
    if (!pin || pin.length !== 4) return alert('PIN must be 4 digits');
    const email = document.getElementById('email').value.trim();
    const phone = document.getElementById('phone').value.trim();
    if (!email || !phone) return alert('Email and Phone required');

    users[username] = {
      username,
      password: pwd,
      pin: pin,
      name: fullName,
      email,
      phone,
      balance: 0,
      wallet: 'W' + Math.floor(Math.random() * 90000 + 10000),
      role: 'user'
    };
    alert(`Registration successful. Your username: ${username}`);
    showPage('start-page');
  }

  function login() {
    const u = document.getElementById('login-username').value.trim();
    const p = document.getElementById('login-password').value;
    if (!users[u] || users[u].password !== p) return alert('Invalid credentials');
    currentUser = users[u];
    if (currentUser.role === 'admin') return showAdminPanel();
    showDashboard();
  }

  function showDashboard() {
    showPage('dashboard');
    document.getElementById('welcome').textContent = `Welcome, ${currentUser.name}`;
    document.getElementById('wallet-number').textContent = currentUser.wallet;
    updateBalance();
    updateHistory();
  }

  function showAdminPanel() {
    showPage('admin-panel');
    document.getElementById('total-users').textContent = Object.values(users).filter(u => u.role === 'user').length;
    document.getElementById('total-charges').textContent = totalCharges.toFixed(2);
    const userTable = Object.values(users).filter(u => u.role === 'user')
      .map(u => `<tr><td>${u.wallet}</td><td>${u.name}</td><td>${u.email}</td><td>${u.phone}</td><td>${u.balance.toFixed(2)}</td></tr>`)
      .join('');
    document.getElementById('admin-user-table').innerHTML = userTable;
    document.getElementById('admin-history').innerHTML = transactionLogs.map(tx => `<li>${tx}</li>`).join('');
  }

  function logout() {
    currentUser = null;
    showPage('start-page');
  }

  function transferMoney() {
    if (!currentUser) return alert('Please login first');
    const toWallet = document.getElementById('recipient').value.trim();
    const amount = parseFloat(document.getElementById('amount').value);
    const pin = document.getElementById('auth-pin').value.trim();
    if (pin !== currentUser.pin) return alert('Wrong PIN');
    if (amount <= 0) return alert('Invalid amount');
    if (currentUser.balance < amount) return alert('Insufficient funds');
    const recipient = Object.values(users).find(u => u.wallet === toWallet);
    if (!recipient) return alert('Recipient wallet not found');
    if (recipient.wallet === currentUser.wallet) return alert('Cannot transfer to self');

    // Transaction charge 1%
    const charge = amount * 0.01;
    const totalDeduct = amount + charge;
    if (currentUser.balance < totalDeduct) return alert('Insufficient funds including charges');

    currentUser.balance -= totalDeduct;
    recipient.balance += amount;
    totalCharges += charge;

    const log = `${currentUser.wallet} sent ${amount.toFixed(2)} to ${recipient.wallet} (+charge ${charge.toFixed(2)})`;
    transactionLogs.push(log);

    alert('Transfer successful');
    updateBalance();
    updateHistory();
    if (currentUser.role === 'admin') showAdminPanel();
  }

  function updateBalance() {
    document.getElementById('wallet-balance').textContent = currentUser.balance.toFixed(2);
  }

  function updateHistory() {
    const ul = document.getElementById(currentUser.role === 'admin' ? 'admin-history' : 'history');
    const filteredLogs = currentUser.role === 'admin' ? transactionLogs : transactionLogs.filter(tx => tx.includes(currentUser.wallet));
    ul.innerHTML = filteredLogs.map(tx => `<li>${tx}</li>`).join('');
  }

  function topUp() {
    const amount = parseFloat(document.getElementById('topup-amount').value);
    if (!amount || amount <= 0) return alert('Invalid amount');
    currentUser.balance += amount;
    alert('Top-up successful');
    updateBalance();
    updateHistory();
  }

  // Export CSV helper
  function exportToCSV(filename, rows) {
    const processRow = row => row.map(item => `"${item.toString().replace(/"/g, '""')}"`).join(',');
    const csvContent = rows.map(processRow).join('\r\n');
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = filename;
    link.style.display = 'none';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }

  function exportUsersCSV() {
    const rows = [['Wallet Number', 'Username', 'Name', 'Email', 'Phone', 'Balance']];
    Object.values(users)
      .filter(u => u.role === 'user')
      .forEach(u => {
        rows.push([u.wallet, u.username, u.name, u.email, u.phone, u.balance.toFixed(2)]);
      });
    exportToCSV('users.csv', rows);
  }

  function exportTransactionsCSV() {
    const rows = [['Timestamp', 'From Wallet', 'To Wallet', 'Amount', 'Charge']];
    transactionLogs.forEach(log => {
      // Format: "W1001 sent 100 to W1002 (+charge 5)"
      const regex = /(\w+) sent ([\d.]+) to (\w+) \(+charge ([\d.]+)\)/;
      const match = log.match(regex);
      if (match) {
        rows.push(['', match[1], match[3], match[2], match[4]]);
      } else {
        rows.push(['', log, '', '', '']);
      }
    });
    exportToCSV('transactions.csv', rows);
  }

  // Start page by default
  showPage('start-page');
</script>
</body>
</html>
