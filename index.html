<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Wallet Platform</title>
  <style>
    body { font-family: Arial; background: #f4f4f4; padding: 20px; }
    .hidden { display: none; }
    .box, .dashboard { background: white; padding: 20px; border-radius: 8px; margin: 10px auto; max-width: 600px; }
    input, select, button { width: 100%; padding: 10px; margin: 10px 0; }
    button.logout { background: #e74c3c; color: white; }
    .inline { display: inline-block; width: 48%; }
    canvas { max-width: 100%; }
  </style>
</head>
<body>

  <!-- START PAGE -->
  <div id="startPage" class="box">
    <h2>Welcome to Wallet Platform</h2>
    <button onclick="showLogin()">Login</button>
    <button onclick="showRegister()">Register</button>
  </div>

  <!-- LOGIN PAGE -->
  <div id="loginPage" class="box hidden">
    <h2>Login</h2>
    <input id="loginUsername" placeholder="Username">
    <input id="loginPassword" type="password" placeholder="Password">
    <button onclick="login()">Log In</button>
    <button onclick="showStart()">Back</button>
  </div>

  <!-- REGISTER PAGE -->
  <div id="registerPage" class="box hidden">
    <h2>Register</h2>
    <input id="regSurname" placeholder="Surname">
    <input id="regMiddle" placeholder="Middle Name (optional)">
    <input id="regFirst" placeholder="First Name">
    <input id="regID" placeholder="ID/Passport Number">
    <input id="regPhone" placeholder="Phone Number">
    <input id="regEmail" placeholder="Email Address">
    <input id="regPassword" type="password" placeholder="Password">
    <input id="regPin" type="password" placeholder="Transaction PIN">

    <label>Select Country</label>
    <select id="regCountry">
      <option value="">--Country--</option>
      <option value="Kenya">Kenya (KES)</option>
      <option value="USA">USA (USD)</option>
      <option value="Japan">Japan (JPY)</option>
    </select>

    <label>Wallet Currency</label>
    <select id="regCurrency">
      <option value="">--Currency--</option>
      <option value="KES">KES</option>
      <option value="USD">USD</option>
      <option value="JPY">JPY</option>
    </select>

    <button onclick="register()">Register</button>
    <button onclick="showStart()">Back</button>
  </div>

  <!-- USER DASHBOARD -->
  <div id="userDashboard" class="dashboard hidden">
    <h2>User Dashboard</h2>
    <div id="userInfo"></div>

    <h3>Send Money</h3>
    <input id="recipientWallet" placeholder="Recipient Wallet#">
    <input id="amount" type="number" placeholder="Amount">
    <input id="confirmPin" type="password" placeholder="PIN">
    <button onclick="transfer()">Send</button>
    <p id="transferMsg"></p>

    <h3>Transaction Log</h3>
    <pre id="transactionLog" style="background:#eef; padding:10px; max-height:200px; overflow:auto;"></pre>

    <button class="logout" onclick="logout()">Logout</button>
  </div>

  <!-- ADMIN DASHBOARD -->
  <div id="adminDashboard" class="dashboard hidden">
    <h2>Admin Dashboard</h2>
    <h3>Trading Wallet Balances</h3>
    <ul id="adminBal"></ul>

    <div class="inline">
      <h4>Transfers by Currency</h4>
      <canvas id="transferChart"></canvas>
    </div>
    <div class="inline">
      <h4>Fees Collected</h4>
      <canvas id="feeChart"></canvas>
    </div>

    <h3>Create Sub-Admin</h3>
    <input id="subName" placeholder="Name">
    <input id="subPass" type="password" placeholder="Password">
    <button onclick="createSubAdmin()">Create Sub-Admin</button>
    <p id="subMsg"></p>

    <h3>Admin Send Money</h3>
    <input id="adminRecipient" placeholder="Recipient Wallet#">
    <input id="adminAmount" type="number" placeholder="Amount">
    <button onclick="adminSend()">Send from Trading Wallet</button>
    <p id="adminSendMsg"></p>

    <button class="logout" onclick="logout()">Logout</button>
  </div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // --- DATA STRUCTURES ---
  const users = {
    admin: {
      password:"admin123", pin:"0000", role:"admin",
      wallets:{KES:0,USD:0,JPY:0}, fees:{KES:0,USD:0,JPY:0}
    },
    kilush: {
      password:"pass123", pin:"1111", role:"user", name:"Kilush",
      wallets:{KES:5000}, logs:[]
    },
    schwadz: {
      password:"pass123", pin:"2222", role:"user", name:"Schwadz",
      wallets:{USD:6.4}, logs:[]
    },
    moses: {
      password:"pass123", pin:"3333", role:"user", name:"Moses",
      wallets:{JPY:1230}, logs:[]
    }
  };
  const walletToUser = {};
  for(let u in users){
    if(users[u].wallets){
      for(let c in users[u].wallets){
        // generate wallet numbers from username+currency
        const w = u.toUpperCase().slice(0,3)+"_"+c;
        users[u].wallets[w]=users[u].wallets[c];
        delete users[u].wallets[c];
        walletToUser[w]=u;
      }
    }
  }
  let currentUser=null;

  // --- UI CONTROLS ---
  function hideAll(){
    document.querySelectorAll('.box,.dashboard').forEach(el=>el.classList.add('hidden'));
  }
  window.onload = ()=> {
    hideAll(); showStart();
  };
  function showStart(){ hideAll(); document.getElementById('startPage').classList.remove('hidden'); }
  function showLogin(){ hideAll(); document.getElementById('loginPage').classList.remove('hidden'); }
  function showRegister(){ hideAll(); document.getElementById('registerPage').classList.remove('hidden'); }
  function showDashboard(){
    hideAll();
    const u = users[currentUser];
    if(u.role==='admin') renderAdmin(); else renderUser();
  }
  function logout(){
    currentUser=null; sessionStorage.removeItem('user');
    showStart();
  }

  // --- AUTH ---
  function login(){
    const u=document.getElementById('loginUsername').value.trim(),
          p=document.getElementById('loginPassword').value;
    if(users[u]&&users[u].password===p){
      currentUser=u; sessionStorage.setItem('user',u); showDashboard();
    } else alert('Invalid credentials');
  }
  function register(){
    const s=document.getElementById('regSurname').value.trim(),
          m=document.getElementById('regMiddle').value.trim(),
          f=document.getElementById('regFirst').value.trim(),
          id=document.getElementById('regID').value.trim(),
          ph=document.getElementById('regPhone').value.trim(),
          em=document.getElementById('regEmail').value.trim(),
          pw=document.getElementById('regPassword').value,
          pi=document.getElementById('regPin').value;
    if(!s||!f||!id||!ph||!em||!pw||!pi) return alert('Fill all');
    if(users[id]) return alert('User exists');
    users[id]={
      password:pw,pin:pi,role:'user',name:`${s} ${m} ${f}`,wallets:{},
      logs:[]
    };
    alert('Registered! Login now');
    showLogin();
  }

  // --- USER DASHBOARD ---
  function renderUser(){
    document.getElementById('userDashboard').classList.remove('hidden');
    const u=users[currentUser];
    let info=`<b>Name:</b>${u.name}<br><b>Wallets:</b><ul>`;
    for(let w in u.wallets) info+=`<li>${w}: ${u.wallets[w].toFixed(2)}</li>`;
    info+='</ul>';
    document.getElementById('userInfo').innerHTML=info;
    displayLog();
  }
  function transfer(){
    const w=document.getElementById('recipientWallet').value.trim(),
          amt=parseFloat(document.getElementById('amount').value),
          pin=document.getElementById('confirmPin').value;
    const s=users[currentUser];
    if(pin!==s.pin) return alert('Wrong PIN');
    if(!walletToUser[w]) return alert('Unknown wallet');
    if(isNaN(amt)||amt<=0) return alert('Invalid amt');
    if(!s.wallets[w]){ // find same currency in any wallet
      const [cur]=Object.keys(s.wallets);
      const bal=s.wallets[cur];
      const fee=Math.min(amt*0.01,1000);
      if(bal<amt+fee) return alert('Insufficient');
      s.wallets[cur]-=amt+fee;
      const r=users[walletToUser[w]];
      r.wallets[w]=(r.wallets[w]||0)+amt;
      // admin fees
      users.admin.wallets[cur]=(users.admin.wallets[cur]||0);
      users.admin.fees[cur]=(users.admin.fees[cur]||0)+fee;
      s.logs.push(`Sent ${amt} ${cur} to ${walletToUser[w]} (Fee ${fee})`);
      alert('Sent');
      renderUser();
    }
    displayLog();
  }
  function displayLog(){
    document.getElementById('transactionLog').textContent=users[currentUser].logs.join('\n');
  }

  // --- ADMIN DASHBOARD ---
  function renderAdmin(){
    document.getElementById('adminDashboard').classList.remove('hidden');
    const a=users.admin;
    let balList='<ul>';
    for(let c in a.wallets) balList+=`<li>Trading ${c}: ${a.wallets[c].toFixed(2)}</li>`;
    balList+='</ul>';
    document.getElementById('adminBal').innerHTML=balList;

    // Sub-admin
    document.getElementById('subMsg').textContent='';

    // Render charts
    const ctx1=document.getElementById('transferChart').getContext('2d'),
          ctx2=document.getElementById('feeChart').getContext('2d'),
          labels=Object.keys(users).filter(u=>users[u].role==='user'),
          txs=labels.map(u=>users[u].logs.length),
          fees=Object.keys(a.fees).map(c=>a.fees[c]);
    new Chart(ctx1,{type:'bar',data:{labels, datasets:[{label:'Transfers',data:txs}]}}); 
    new Chart(ctx2,{type:'bar',data:{labels:Object.keys(a.fees), datasets:[{label:'Fees',data:fees}]}}); 
  }
  function createSubAdmin(){
    const n=document.getElementById('subName').value.trim(),
          p=document.getElementById('subPass').value;
    if(!n||!p) return alert('Fill fields');
    users[n]={password:p,pin:'0000',role:'admin',wallets:{},fees:{},logs:[]};
    document.getElementById('subMsg').textContent='Sub-admin created';
    renderAdmin();
  }
  function adminSend(){
    const w=document.getElementById('adminRecipient').value.trim(),
          amt=parseFloat(document.getElementById('adminAmount').value);
    if(!walletToUser[w]) return alert('Unknown wallet');
    if(isNaN(amt)||amt<=0) return alert('Bad amt');
    // assume all in first trading currency:
    const cur=Object.keys(users.admin.wallets)[0];
    if(users.admin.wallets[cur]<amt) return alert('Low funds');
    users.admin.wallets[cur]-=amt;
    const r=users[walletToUser[w]];
    r.wallets[w]=(r.wallets[w]||0)+amt;
    document.getElementById('adminSendMsg').textContent='Sent';
    renderAdmin();
  }
</script>
</body>
</html>
