<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Multi-Currency Wallet Platform</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; background: #f0f0f0; }
  #wallet, #transfer-section, #confirmation-popup, #pin-popup {
    background: white; padding: 20px; margin-bottom: 20px; border-radius: 6px; box-shadow: 0 0 10px #aaa;
  }
  #confirmation-popup, #pin-popup {
    position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
    display: none; width: 300px; z-index: 100;
  }
  .popup-header { font-weight: bold; margin-bottom: 10px; }
  button { padding: 10px 15px; margin-top: 10px; cursor: pointer; }
  input, select { padding: 8px; width: 100%; margin: 5px 0 10px 0; box-sizing: border-box; }
  .error { color: red; margin-top: 10px; }
  .success { color: green; margin-top: 10px; }
</style>
</head>
<body>

<h1>Multi-Currency Wallet Demo</h1>

<div id="wallet">
  <h2>Your Wallet Balances</h2>
  <ul id="balances-list"></ul>
</div>

<div id="transfer-section">
  <h2>Transfer Funds</h2>
  <label for="from-currency">From Currency:</label>
  <select id="from-currency"></select>

  <label for="recipient-account">Recipient Account Number:</label>
  <input type="text" id="recipient-account" placeholder="Enter recipient account number" />

  <label for="to-currency">To Currency:</label>
  <select id="to-currency"></select>

  <label for="transfer-amount">Amount to Transfer:</label>
  <input type="number" id="transfer-amount" placeholder="Enter amount" min="0" step="0.01" />

  <button id="initiate-transfer-btn">Initiate Transfer</button>

  <div id="transfer-message"></div>
</div>

<!-- Confirmation Popup -->
<div id="confirmation-popup">
  <div class="popup-header">Confirm Transfer Details</div>
  <div id="confirmation-details"></div>
  <button id="confirm-transfer-btn">Confirm</button>
  <button id="cancel-confirmation-btn">Cancel</button>
  <div id="confirmation-error" class="error"></div>
</div>

<!-- PIN Authorization Popup -->
<div id="pin-popup">
  <div class="popup-header">Enter PIN to Authorize</div>
  <input type="password" id="pin-input" placeholder="Enter your PIN" maxlength="6" />
  <button id="authorize-transfer-btn">Authorize</button>
  <button id="cancel-pin-btn">Cancel</button>
  <div id="pin-error" class="error"></div>
</div>

<script>
  // Demo user wallet data (replace with actual user data as needed)
  let walletBalances = {
    USD: 1000,
    EUR: 800,
    KES: 50000,
    GBP: 400,
  };

  // Simulated users database keyed by account number (demo)
  const usersDb = {
    "ACC1001": { name: "Alice Johnson", wallet: { USD: 300, EUR: 150 } },
    "ACC1002": { name: "Bob Smith", wallet: { KES: 20000, GBP: 100 } },
    // Add more users here as needed
  };

  // Simulated current user
  const currentUserAccountNumber = "ACC0001";
  const currentUserName = "Current User";

  // Admin fee wallet in EUR
  let adminFeeWalletEUR = 0;

  // Exchange rates relative to EUR (demo static rates)
  const exchangeRates = {
    EUR: 1,
    USD: 1.1,
    KES: 120,
    GBP: 0.9,
  };

  // Transaction fee logic:
  // 0.5% fee for amounts >= KES 250 equivalent, capped at KES 1000 equivalent
  function calculateFee(amount, currency) {
    const amountInKES = amount * (exchangeRates[currency] ? exchangeRates[currency] * 100 : 1) / exchangeRates["KES"];
    if (amountInKES < 250) return 0;
    let feeKES = amountInKES * 0.005;
    if (feeKES > 1000) feeKES = 1000;
    return feeKES / exchangeRates["KES"] * exchangeRates[currency]; // convert back to original currency approx.
  }

  // Populate currency selectors
  const currencies = Object.keys(walletBalances);
  const fromCurrencySelect = document.getElementById("from-currency");
  const toCurrencySelect = document.getElementById("to-currency");
  currencies.forEach(c => {
    let optionFrom = document.createElement("option");
    optionFrom.value = c;
    optionFrom.textContent = c;
    fromCurrencySelect.appendChild(optionFrom);
    let optionTo = document.createElement("option");
    optionTo.value = c;
    optionTo.textContent = c;
    toCurrencySelect.appendChild(optionTo);
  });
  toCurrencySelect.value = currencies[0]; // default

  // Display wallet balances
  function renderBalances() {
    const list = document.getElementById("balances-list");
    list.innerHTML = "";
    for (const [currency, amount] of Object.entries(walletBalances)) {
      const li = document.createElement("li");
      li.textContent = `${currency}: ${amount.toFixed(2)}`;
      list.appendChild(li);
    }
  }
  renderBalances();

  // Globals for transfer flow
  let transferDetails = null;

  // Initiate transfer button click
  document.getElementById("initiate-transfer-btn").onclick = function() {
    clearMessages();

    const fromCurrency = fromCurrencySelect.value;
    const toCurrency = toCurrencySelect.value;
    const recipientAccount = document.getElementById("recipient-account").value.trim();
    const amount = parseFloat(document.getElementById("transfer-amount").value);

    // Basic validations
    if (!recipientAccount) {
      showTransferMessage("Recipient account number is required.", true);
      return;
    }
    if (!usersDb[recipientAccount]) {
      showTransferMessage("Recipient account not found.", true);
      return;
    }
    if (recipientAccount === currentUserAccountNumber) {
      showTransferMessage("Cannot transfer to your own account.", true);
      return;
    }
    if (isNaN(amount) || amount <= 0) {
      showTransferMessage("Enter a valid positive amount.", true);
      return;
    }
    if (walletBalances[fromCurrency] === undefined) {
      showTransferMessage("You do not have the selected from currency.", true);
      return;
    }
    if (walletBalances[fromCurrency] < amount) {
      showTransferMessage("Insufficient funds in your wallet.", true);
      return;
    }

    // Prepare transfer details for confirmation
    const recipientName = usersDb[recipientAccount].name;
    const fee = calculateFee(amount, fromCurrency);
    const totalDebit = amount + fee;

    transferDetails = {
      fromCurrency,
      toCurrency,
      recipientAccount,
      recipientName,
      amount,
      fee,
      totalDebit,
    };

    // Show confirmation popup
    showConfirmationPopup(transferDetails);
  };

  function showTransferMessage(msg, isError = false) {
    const container = document.getElementById("transfer-message");
    container.textContent = msg;
    container.className = isError ? "error" : "success";
  }

  function clearMessages() {
    document.getElementById("transfer-message").textContent = "";
    document.getElementById("confirmation-error").textContent = "";
    document.getElementById("pin-error").textContent = "";
  }

  // Confirmation popup elements
  const confirmationPopup = document.getElementById("confirmation-popup");
  const confirmationDetails = document.getElementById("confirmation-details");
  const confirmationError = document.getElementById("confirmation-error");

  function showConfirmationPopup(details) {
    confirmationDetails.innerHTML = `
      <p><strong>Recipient:</strong> ${details.recipientName} (${details.recipientAccount})</p>
      <p><strong>From:</strong> ${details.fromCurrency}</p>
      <p><strong>To:</strong> ${details.toCurrency}</p>
      <p><strong>Amount:</strong> ${details.amount.toFixed(2)} ${details.fromCurrency}</p>
      <p><strong>Fee:</strong> ${details.fee.toFixed(2)} ${details.fromCurrency}</p>
      <p><strong>Total Debit:</strong> ${details.totalDebit.toFixed(2)} ${details.fromCurrency}</p>
    `;
    confirmationPopup.style.display = "block";
  }

  // Confirmation popup buttons
  document.getElementById("confirm-transfer-btn").onclick = function() {
    confirmationError.textContent = "";
    confirmationPopup.style.display = "none";
    showPinPopup();
  };
  document.getElementById("cancel-confirmation-btn").onclick = function() {
    confirmationPopup.style.display = "none";
    transferDetails = null;
  };

  // PIN popup elements
  const pinPopup = document.getElementById("pin-popup");
  const pinInput = document.getElementById("pin-input");
  const pinError = document.getElementById("pin-error");

  function showPinPopup() {
    pinInput.value = "";
    pinError.textContent = "";
    pinPopup.style.display = "block";
    pinInput.focus();
  }

  // Simulated PIN for demo (hardcoded)
  const userPin = "123456";

  document.getElementById("authorize-transfer-btn").onclick = function() {
    pinError.textContent = "";
    if (pinInput.value !== userPin) {
      pinError.textContent = "Invalid PIN. Try again.";
      return;
    }
    pinPopup.style.display = "none";
    processTransfer();
  };

  document.getElementById("cancel-pin-btn").onclick = function() {
    pinPopup.style.display = "none";
    transferDetails = null;
  };

  // Process the transfer after PIN auth
  function processTransfer() {
    if (!transferDetails) {
      showTransferMessage("No transfer details found.", true);
      return;
    }

    const { fromCurrency, toCurrency, recipientAccount, amount, fee, totalDebit } = transferDetails;

    // Deduct total debit (amount + fee) from sender wallet
    walletBalances[fromCurrency] -= totalDebit;

    // Convert amount to recipient currency if different
    let convertedAmount = amount;
    if (fromCurrency !== toCurrency) {
      const eurAmount = amount / exchangeRates[fromCurrency]; // to EUR
      convertedAmount = eurAmount * exchangeRates[toCurrency];
    }

    // Credit recipient wallet
    if (!usersDb[recipientAccount].wallet[toCurrency]) {
      usersDb[recipientAccount].wallet[toCurrency] = 0;
    }
    usersDb[recipientAccount].wallet[toCurrency] += convertedAmount;

    // Add fee (converted to EUR) to admin fee wallet
    const feeInEUR = fee / exchangeRates[fromCurrency]; // approx convert fee to EUR
    adminFeeWalletEUR += feeInEUR;

    // Reset transfer details
    transferDetails = null;

    renderBalances();
    showTransferMessage(`Transfer successful. Sent ${amount.toFixed(2)} ${fromCurrency} to ${usersDb[recipientAccount].name} (${recipientAccount}). Fee: ${fee.toFixed(2)} ${fromCurrency}`);
  }
</script>

</body>
</html>
