// app.js - Main Logic for Trade Partner Wallet Platform

let users = {
  kilush: {
    name: "Kilush",
    email: "kilush@example.com",
    password: "kilush123",
    pin: "1234",
    walletId: "WAL1001",
    balances: { KES: 1000 },
    tx: [],
    isAdmin: false,
  },
  schwadz: {
    name: "Schwadz",
    email: "schwadz@example.com",
    password: "schwadz123",
    pin: "1234",
    walletId: "WAL1002",
    balances: { USD: 6.4 },
    tx: [],
    isAdmin: false,
  },
  moses: {
    name: "Moses",
    email: "moses@example.com",
    password: "moses123",
    pin: "1234",
    walletId: "WAL1003",
    balances: { JPY: 1230 },
    tx: [],
    isAdmin: false,
  },
  admin: {
    name: "Admin",
    email: "admin@example.com",
    password: "admin123",
    pin: "0000",
    isAdmin: true,
    walletId: "ADMIN",
    balances: { KES: 0, USD: 0, JPY: 0 },
    tx: [],
  },
};

let currentUser = null;
const exchangeRates = {
  KES: { USD: 0.0064, JPY: 1.23 },
  USD: { KES: 155.3 },
  JPY: { KES: 0.81 },
};
const txLog = [];
const adminChargeWallet = { KES: 0, USD: 0, JPY: 0 };

// Utility functions
function generateWalletID() {
  return "WAL" + Math.floor(Math.random() * 100000);
}

function validateCredentials(username, password) {
  return users[username] && users[username].password === password;
}

function registerUser(name, email, password, pin, preferredCurrency) {
  const username = name.toLowerCase();
  if (users[username]) return false;

  const walletId = generateWalletID();
  users[username] = {
    name,
    email,
    password,
    pin,
    walletId,
    balances: { [preferredCurrency]: 1000 },
    tx: [],
    isAdmin: false,
  };
  return true;
}
function transferMoney(senderUsername, recipientUsername, amount, currency) {
  const sender = users[senderUsername];
  const recipient = users[recipientUsername];

  if (!sender || !recipient) {
    alert("Invalid sender or recipient.");
    return false;
  }

  const now = new Date();

  // Check for duplicate transaction
  const duplicate = sender.tx.find((t) => {
    return (
      t.to === recipientUsername &&
      t.amount === amount &&
      t.currency === currency &&
      now - new Date(t.timestamp) < 60000 // 1 min
    );
  });

  if (duplicate) {
    alert("You cannot send an identical transaction within 1 minute.");
    return false;
  }

  // Transaction charge: 1%, capped at KES 1000
  let charge = amount * 0.01;
  if (currency === "KES" && charge > 1000) charge = 1000;
  charge = Math.floor(charge * 100) / 100;

  const totalDebit = amount + charge;

  if (!sender.balances[currency] || sender.balances[currency] < totalDebit) {
    alert("Insufficient balance.");
    return false;
  }

  // Confirm recipient before proceeding
  if (
    !confirm(
      `Send ${amount} ${currency} to ${recipient.name} (${recipient.walletId})?\nA transaction charge of ${charge} ${currency} applies.`
    )
  ) {
    return false;
  }

  // Deduct from sender
  sender.balances[currency] -= totalDebit;

  // Add to recipient instantly
  if (!recipient.balances[currency]) {
    recipient.balances[currency] = 0;
  }
  recipient.balances[currency] += amount;

  // Add charge to admin wallet
  if (!adminChargeWallet[currency]) adminChargeWallet[currency] = 0;
  adminChargeWallet[currency] += charge;

  // Log transaction
  const tx = {
    from: senderUsername,
    to: recipientUsername,
    amount,
    currency,
    charge,
    timestamp: now.toISOString(),
  };
  sender.tx.push(tx);
  recipient.tx.push(tx);
  txLog.push(tx);

  alert("Transfer successful!");
  return true;
}
