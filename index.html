<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Wallet Platform</title>
  <style>
    body { font-family: Arial; padding: 20px; background: #f4f4f4; }
    .hidden { display: none; }
    .box, .dashboard { background: white; padding: 20px; border-radius: 10px; max-width: 800px; margin: auto; margin-bottom: 20px; }
    input, button, select { display: block; width: 100%; padding: 10px; margin: 10px 0; }
    canvas { width: 100%; height: 200px; margin: 20px 0; }
  </style>
</head>
<body>
  <!-- UI SECTIONS (start, login, register, user dashboard, admin dashboard) -->
  <!-- ... (Your existing HTML content remains unchanged, already posted above) -->

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const users = {
      admin: { password: "admin123", pin: "0000", balance: 1000000, wallet: "ADM001", role: "admin", name: "Administrator", currency: "KES" },
      kilush: { password: "pass123", pin: "1111", balance: 5000, wallet: "KIL001", role: "user", name: "Kilush Kamau", currency: "KES" },
      schwadz: { password: "pass123", pin: "2222", balance: 57.00, wallet: "SCH001", role: "user", name: "Schwadz M", currency: "USD" },
      moses: { password: "pass123", pin: "3333", balance: 3630.00, wallet: "MOS001", role: "user", name: "Moses L", currency: "JPY" },
    };

    const walletToUser = {};
    for (let username in users) {
      walletToUser[users[username].wallet] = username;
    }

    let currentUser = null;
    let transactionLog = [];

    window.onload = () => {
      const saved = sessionStorage.getItem("loggedUser");
      if (saved && users[saved]) {
        currentUser = saved;
        showDashboard();
      } else {
        showStart();
      }
    };

    function hideAll() {
      document.querySelectorAll('.box, .dashboard').forEach(e => e.classList.add('hidden'));
    }

    function showStart() {
      hideAll();
      document.getElementById("startPage").classList.remove("hidden");
    }

    function showLogin() {
      hideAll();
      document.getElementById("loginPage").classList.remove("hidden");
    }

    function showRegister() {
      hideAll();
      document.getElementById("registerPage").classList.remove("hidden");
    }

    function login() {
      const username = document.getElementById("loginUsername").value.trim();
      const password = document.getElementById("loginPassword").value.trim();
      if (users[username] && users[username].password === password) {
        currentUser = username;
        sessionStorage.setItem("loggedUser", username);
        showDashboard();
      } else {
        alert("Invalid login.");
      }
    }

    function register() {
      const surname = document.getElementById("regSurname").value.trim();
      const middle = document.getElementById("regMiddle").value.trim();
      const first = document.getElementById("regFirst").value.trim();
      const id = document.getElementById("regID").value.trim();
      const phone = document.getElementById("regPhone").value.trim();
      const email = document.getElementById("regEmail").value.trim();
      const password = document.getElementById("regPassword").value.trim();
      const pin = document.getElementById("regPin").value.trim();

      if (!surname || !first || !id || !phone || !email || !password || !pin) {
        alert("All required fields must be filled.");
        return;
      }

      const username = id;
      if (users[username]) {
        alert("User already exists.");
        return;
      }

      const wallet = "USR" + Math.floor(Math.random() * 10000);
      users[username] = {
        password, pin, balance: 0, wallet, role: "user",
        name: `${surname} ${middle} ${first}`.trim(),
        currency: "KES"
      };
      walletToUser[wallet] = username;
      alert(`Registration successful! Your username is ${username}`);
      showLogin();
    }

    function showDashboard() {
      hideAll();
      const user = users[currentUser];
      if (!user) return;

      if (user.role === "admin") {
        document.getElementById("adminDashboard").classList.remove("hidden");
        renderAdminView();
        renderCurrencyGraph();
        document.getElementById("tradingWalletBalance").innerText = `${user.balance} ${user.currency}`;
      } else {
        document.getElementById("userDashboard").classList.remove("hidden");
        document.getElementById("userInfo").innerHTML = `
          <b>Name:</b> ${user.name}<br>
          <b>Wallet:</b> ${user.wallet}<br>
          <b>Balance:</b> ${user.balance} ${user.currency}
        `;
        displayTransactionLog();
      }
    }

    function logout() {
      currentUser = null;
      sessionStorage.removeItem("loggedUser");
      showStart();
    }

    function transfer() {
      const sender = users[currentUser];
      const recipientWallet = document.getElementById("recipientWallet").value.trim();
      const amount = parseFloat(document.getElementById("amount").value.trim());
      const pin = document.getElementById("confirmPin").value.trim();

      if (!walletToUser[recipientWallet]) return alert("Invalid wallet.");
      if (pin !== sender.pin) return alert("Incorrect PIN.");
      if (isNaN(amount) || amount <= 0) return alert("Enter valid amount.");

      const recipient = users[walletToUser[recipientWallet]];
      if (recipient.currency !== sender.currency) return alert("Currency mismatch!");

      const now = Date.now();
      if (now - (sender.lastTx || 0) < 60000 && sender.lastDetails === `${recipientWallet}-${amount}`) {
        return alert("Wait a minute before repeating the same transfer.");
      }

      let fee = Math.min(Math.ceil(amount * 0.01), 1000);
      if (sender.balance < amount + fee) return alert("Insufficient funds.");

      sender.balance -= (amount + fee);
      recipient.balance += amount;
      sender.lastTx = now;
      sender.lastDetails = `${recipientWallet}-${amount}`;

      transactionLog.push(`${sender.name} sent ${amount} ${sender.currency} to ${recipient.name}. Fee: ${fee}`);
      alert("Transfer successful!");
      showDashboard();
    }

    function adminTransfer() {
      const admin = users["admin"];
      const recipientWallet = document.getElementById("adminRecipientWallet").value.trim();
      const amount = parseFloat(document.getElementById("adminAmount").value.trim());
      const pin = document.getElementById("adminPin").value.trim();

      if (!walletToUser[recipientWallet]) return alert("Invalid wallet.");
      if (pin !== admin.pin) return alert("Incorrect PIN.");
      if (isNaN(amount) || amount <= 0) return alert("Enter valid amount.");

      const recipient = users[walletToUser[recipientWallet]];
      if (recipient.currency !== admin.currency) return alert("Currency mismatch!");

      if (admin.balance < amount) return alert("Insufficient funds.");

      admin.balance -= amount;
      recipient.balance += amount;

      transactionLog.push(`Admin sent ${amount} KES to ${recipient.name}`);
      alert("Transfer complete.");
      showDashboard();
    }

    function createSubAdmin() {
      const username = document.getElementById("subAdminUsername").value.trim();
      const password = document.getElementById("subAdminPassword").value.trim();
      const pin = document.getElementById("subAdminPin").value.trim();

      if (!username || !password || !pin) return alert("Fill all fields");
      if (users[username]) return alert("User exists");

      const wallet = "SUB" + Math.floor(Math.random() * 10000);
      users[username] = { password, pin, balance: 0, wallet, role: "subadmin", name: username, currency: "KES" };
      walletToUser[wallet] = username;
      alert("Sub-admin created.");
    }

    function renderAdminView() {
      let html = "<h3>All Users</h3><ul>";
      for (let u in users) {
        html += `<li>${u} (${users[u].wallet}) - ${users[u].balance} ${users[u].currency} [${users[u].role}]</li>`;
      }
      html += "</ul>";
      document.getElementById("adminView").innerHTML = html;
    }

    function renderCurrencyGraph() {
      const ctx = document.getElementById("currencyGraph").getContext("2d");
      const currencyData = {};
      for (let u in users) {
        const c = users[u].currency;
        currencyData[c] = (currencyData[c] || 0) + 1;
      }

      new Chart(ctx, {
        type: "bar",
        data: {
          labels: Object.keys(currencyData),
          datasets: [{
            label: "Users per Currency",
            data: Object.values(currencyData),
            backgroundColor: ["#4caf50", "#2196f3", "#ff9800"]
          }]
        }
      });
    }

    function displayTransactionLog() {
      document.getElementById("transactionLog").innerText = transactionLog.slice(-10).join("\n");
    }
  </script>
</body>
</html>
