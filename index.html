<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Global Wallet Platform</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background-color: #f9f9f9; }
    .hidden { display: none; }
    input, select, button { margin: 5px; padding: 6px; width: 200px; }
    #confirmation-section { border: 1px solid #ccc; padding: 10px; margin-top: 10px; background: #fff; }
    canvas { max-width: 500px; margin: 10px; background: #fff; }
    h2, h3, h4 { color: #333; }
    button { background-color: #4CAF50; color: white; border: none; cursor: pointer; }
    button:hover { background-color: #45a049; }
    select { width: 210px; }
  </style>
</head>
<body>

<h2>Global Wallet Platform</h2>

<div id="start-section">
  <button onclick="showSection('login-section')">Login</button>
  <button onclick="showSection('register-section')">Register</button>
</div>

<!-- Registration Section -->
<div id="register-section" class="hidden">
  <h3>Register</h3>
  <input id="reg-username" placeholder="Username" />
  <input id="reg-password" type="password" placeholder="Password" />
  <input id="reg-email" placeholder="Email" />
  <input id="reg-pin" placeholder="PIN (4 digits)" maxlength="4" />
  <select id="country"></select>
  <select id="currency"></select><br>
  <button onclick="register()">Register</button>
  <button onclick="showSection('start-section')">Back</button>
</div>

<!-- Login Section -->
<div id="login-section" class="hidden">
  <h3>Login</h3>
  <input id="login-username" placeholder="Username" />
  <input id="login-password" type="password" placeholder="Password" />
  <button onclick="login()">Login</button>
  <button onclick="showSection('start-section')">Back</button>
</div>
    }

    function prepareTransfer() {
      const recipientWallet = document.getElementById('recipient').value.trim();
      const amount = parseFloat(document.getElementById('amount').value);
      const pin = document.getElementById('auth-pin').value.trim();

      if (!recipientWallet || !amount || !pin) {
        alert("All fields required.");
        return;
      }

      if (pin !== currentUser.pin) {
        alert("Incorrect PIN.");
        return;
      }

      const recipient = Object.values(users).find(u => u.wallet === recipientWallet);
      if (!recipient) {
        alert("Recipient not found.");
        return;
      }

      const amountInKES = convertCurrency(amount, currentUser.currency, "KES");
      const charge = amountInKES >= 250 ? Math.min(amountInKES * 0.005, 1000) : 0;
      const chargeInSenderCurrency = convertCurrency(charge, "KES", currentUser.currency);

      const totalDebit = amount + chargeInSenderCurrency;

      if (currentUser.balance < totalDebit) {
        alert("Insufficient funds including fee.");
        return;
      }

      // Store temporary transfer info
      currentTransfer = {
        recipientWallet, recipient,
        amount,
        chargeInSenderCurrency,
        originalChargeKES: charge
      };

      document.getElementById('confirm-recipient').textContent = recipientWallet;
      document.getElementById('confirm-amount').textContent = amount.toFixed(2) + ' ' + currentUser.currency;
      showSection('confirmation-section');
    }

    function confirmTransfer() {
      const { recipientWallet, recipient, amount, chargeInSenderCurrency, originalChargeKES } = currentTransfer;

      currentUser.balance -= amount + chargeInSenderCurrency;
      recipient.balance += convertCurrency(amount, currentUser.currency, recipient.currency);

      totalCharges["KES"] += originalChargeKES;

      const log = `Transferred ${amount.toFixed(2)} ${currentUser.currency} to ${recipientWallet}`;
      transactionLogs.push(log);

      alert("Transfer successful.");
      showDashboard(currentUsername);
    }

    function cancelTransfer() {
      showSection('dashboard-section');
    }

    function createSubAdmin() {
      const username = document.getElementById("subadmin-username").value.trim();
      const password = document.getElementById("subadmin-password").value.trim();
      const email = document.getElementById("subadmin-email").value.trim();
      const pin = document.getElementById("subadmin-pin").value.trim();
      const permissions = Array.from(document.getElementById("subadmin-permissions").selectedOptions).map(o => o.value);

      if (!username || !password || !email || !pin) {
        alert("All fields are required");
        return;
      }

      users[username] = {
        password, email, pin,
        wallet: "SUB" + Math.floor(1000 + Math.random() * 9000),
        balance: 0,
        role: "subadmin",
        currency: "KES",
        permissions
      };

      alert("Sub-admin created.");
      showSection("dashboard-section");
    }

    function transferCharges() {
      const currency = document.getElementById("transfer-currency").value;
      const amount = parseFloat(document.getElementById("transfer-amount").value);

      if (!amount || amount > totalCharges[currency]) {
        alert("Invalid amount or insufficient charges collected.");
        return;
      }

      users["admin"].balance += amount;
      totalCharges[currency] -= amount;

      transactionLogs.push(`Moved ${amount} ${currency} to trading wallet`);
      alert("Funds moved to trading wallet.");
      showDashboard(currentUsername);
    }

    function renderCharts() {
      const ctx1 = document.getElementById("transactionsChart").getContext("2d");
      const ctx2 = document.getElementById("balancesChart").getContext("2d");

      new Chart(ctx1, {
        type: "bar",
        data: {
          labels: Object.keys(totalCharges),
          datasets: [{
            label: "Transaction Charges Collected (KES equivalent)",
            data: Object.keys(totalCharges).map(cur => convertCurrency(totalCharges[cur], cur, "KES")),
            backgroundColor: "rgba(255, 99, 132, 0.6)"
          }]
        }
      });

      new Chart(ctx2, {
        type: "pie",
        data: {
          labels: Object.keys(users),
          datasets: [{
            label: "User Balances",
            data: Object.values(users).map(u => convertCurrency(u.balance, u.currency, "KES")),
            backgroundColor: ["#36a2eb", "#ffcd56", "#4bc0c0", "#9966ff"]
          }]
        }
      });
    }

    showSection("start-section");
  </script>
</body>
</html>
