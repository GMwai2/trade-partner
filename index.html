<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Wallet Platform with Admin & KYC</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f0f2f5; }
    h2 { margin-top: 0; }
    .hidden { display: none; }
    input, select, button { margin: 5px 0; padding: 8px; width: 100%; max-width: 300px; }
    label { display: block; margin-top: 10px; font-weight: bold; }
    #dashboard, #adminDashboard, #transactionHistory { margin-top: 20px; background: white; padding: 20px; border-radius: 5px; }
    #messages { color: green; margin-bottom: 10px; }
    #errors { color: red; margin-bottom: 10px; }
    canvas { max-width: 600px; margin: 10px 0; }
    table { border-collapse: collapse; width: 100%; max-width: 800px; margin-top: 10px; }
    th, td { border: 1px solid #ddd; padding: 8px; }
    th { background: #333; color: white; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<h1>Wallet Platform</h1>

<div id="messages"></div>
<div id="errors"></div>

<div id="authSection">
  <h2>Login</h2>
  <label for="loginUsername">Username or Email</label>
  <input type="text" id="loginUsername" placeholder="Username or Email" />
  <label for="loginPassword">Password</label>
  <input type="password" id="loginPassword" placeholder="Password" />
  <button onclick="login()">Login</button>
  <hr />
  <h2>Register New User</h2>
  <form id="registerForm" onsubmit="return registerUser(event)">
    <label for="regSurname">Surname *</label>
    <input type="text" id="regSurname" required />
    <label for="regMiddleName">Middle Name</label>
    <input type="text" id="regMiddleName" />
    <label for="regFirstName">First Name *</label>
    <input type="text" id="regFirstName" required />
    <label for="regID">ID / Passport Number *</label>
    <input type="text" id="regID" required />
    <label for="regPhone">Phone Number *</label>
    <input type="tel" id="regPhone" required />
    <label for="regEmail">Email Address *</label>
    <input type="email" id="regEmail" required />
    <label for="regPassword">Password *</label>
    <input type="password" id="regPassword" required />
    <label for="regPIN">4-Digit PIN *</label>
    <input type="password" id="regPIN" maxlength="4" pattern="\\d{4}" required />
    <button type="submit">Register</button>
  </form>
</div>

<div id="dashboard" class="hidden">
  <h2>User Dashboard</h2>
  <p>Welcome, <span id="userFullName"></span>!</p>
  <p><strong>Transaction Wallet Balance:</strong> KES <span id="transactionWalletBalance">0</span></p>
  <p><strong>Trading Wallet Balance:</strong> KES <span id="tradingWalletBalance">0</span></p>
  <button onclick="logout()">Logout</button>
</div>

<div id="adminDashboard" class="hidden">
  <h2>Admin Dashboard</h2>
  <p>Welcome Admin!</p>
  <p><strong>Transaction Wallet Total:</strong> KES <span id="adminTransactionWalletTotal">0</span></p>
  <p><strong>Trading Wallet Total:</strong> KES <span id="adminTradingWalletTotal">0</span></p>
  <button onclick="logout()">Logout</button>
</div>

<script>
  const USERS_KEY = 'walletUsers';
  const LOGGED_IN_KEY = 'walletLoggedInUser';

  const hardcodedAdmin = {
    username: 'admin',
    password: 'Admin@123',
    email: 'admin@example.com',
    phone: '0000000000',
    surname: 'Admin',
    middleName: '',
    firstName: 'User',
    idNumber: 'ADMIN001',
    pin: '0000',
    wallets: { transaction: 1000000, trading: 500000 },
    isAdmin: true
  };

  function loadUsers() {
    let users = JSON.parse(localStorage.getItem(USERS_KEY) || '[]');
    const exists = users.some(u => u.username === hardcodedAdmin.username);
    if (!exists) {
      users.push(hardcodedAdmin);
      localStorage.setItem(USERS_KEY, JSON.stringify(users));
    }
    return users;
  }

  function saveUsers(users) {
    localStorage.setItem(USERS_KEY, JSON.stringify(users));
  }

  function setLoggedInUser(username) {
    localStorage.setItem(LOGGED_IN_KEY, username);
  }

  function getLoggedInUser() {
    return localStorage.getItem(LOGGED_IN_KEY);
  }

  function clearLoggedInUser() {
    localStorage.removeItem(LOGGED_IN_KEY);
  }

  function clearMessages() {
    document.getElementById('messages').textContent = '';
    document.getElementById('errors').textContent = '';
  }

  function showMessage(msg) {
    document.getElementById('messages').textContent = msg;
    document.getElementById('errors').textContent = '';
  }

  function showError(msg) {
    document.getElementById('errors').textContent = msg;
    document.getElementById('messages').textContent = '';
  }

  function findUserByUsernameOrEmail(identifier) {
    const users = loadUsers();
    identifier = identifier.toLowerCase();
    return users.find(u => u.username.toLowerCase() === identifier || u.email.toLowerCase() === identifier);
  }

  function login() {
    clearMessages();
    const input = document.getElementById('loginUsername').value.trim().toLowerCase();
    const password = document.getElementById('loginPassword').value;

    const users = loadUsers();
    const user = users.find(u =>
      u.username.toLowerCase() === input || u.email.toLowerCase() === input
    );

    if (!user) {
      showError('User not found.');
      return;
    }

    if (user.password !== password) {
      showError('Incorrect password.');
      return;
    }

    setLoggedInUser(user.username);
    showMessage(`Welcome ${user.firstName}!`);
    renderDashboard();
  }

  function logout() {
    clearLoggedInUser();
    document.getElementById('authSection').classList.remove('hidden');
    document.getElementById('dashboard').classList.add('hidden');
    document.getElementById('adminDashboard').classList.add('hidden');
    clearMessages();
  }

  function renderDashboard() {
    const username = getLoggedInUser();
    if (!username) return;

    const users = loadUsers();
    const user = users.find(u => u.username === username);
    if (!user) return;

    document.getElementById('authSection').classList.add('hidden');

    if (user.isAdmin) {
      document.getElementById('adminDashboard').classList.remove('hidden');
      document.getElementById('adminTransactionWalletTotal').textContent = user.wallets.transaction;
      document.getElementById('adminTradingWalletTotal').textContent = user.wallets.trading;
    } else {
      document.getElementById('dashboard').classList.remove('hidden');
      document.getElementById('userFullName').textContent = `${user.surname} ${user.firstName}`;
      document.getElementById('transactionWalletBalance').textContent = user.wallets.transaction;
      document.getElementById('tradingWalletBalance').textContent = user.wallets.trading;
    }
  }

  function registerUser(event) {
    event.preventDefault();
    clearMessages();

    const surname = document.getElementById('regSurname').value.trim();
    const middle = document.getElementById('regMiddleName').value.trim();
    const first = document.getElementById('regFirstName').value.trim();
    const idNum = document.getElementById('regID').value.trim().toLowerCase();
    const phone = document.getElementById('regPhone').value.trim();
    const email = document.getElementById('regEmail').value.trim().toLowerCase();
    const password = document.getElementById('regPassword').value;
    const pin = document.getElementById('regPIN').value;

    if (!surname || !first || !idNum || !phone || !email || !password || pin.length !== 4) {
      showError("All required fields must be correctly filled.");
      return false;
    }

    const username = idNum;
    const users = loadUsers();
    if (users.find(u => u.username === username)) {
      showError("A user with this ID already exists.");
      return false;
    }

    const newUser = {
      username, email, phone, surname, middleName: middle, firstName: first, idNumber: idNum,
      password, pin,
      wallets: { transaction: 0, trading: 0 },
      isAdmin: false
    };

    users.push(newUser);
    saveUsers(users);
    showMessage("Registration successful. You can now log in.");
    document.getElementById('registerForm').reset();
    return false;
  }

  window.onload = function () {
    loadUsers(); // ensure admin is added
    const loggedIn = getLoggedInUser();
    if (loggedIn) renderDashboard();
  };
</script>

</body>
</html>
