<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Fintech Wallet Platform - Full KYC & Transactions</title>
<style>
  body { font-family: Arial, sans-serif; background: #f5f7fa; margin: 0; padding: 0; }
  header { background: #004080; color: white; padding: 1rem; text-align: center; }
  main { max-width: 900px; margin: 1rem auto; background: white; padding: 1rem 2rem; border-radius: 6px; box-shadow: 0 0 10px rgba(0,0,0,0.1);}
  h2 { color: #004080; }
  form > div { margin-bottom: 1rem; }
  label { display: block; font-weight: bold; margin-bottom: 0.3rem; }
  input[type=text], input[type=email], input[type=tel], input[type=password], input[type=file], select {
    width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px;
  }
  button { background: #004080; color: white; border: none; padding: 0.7rem 1.2rem; cursor: pointer; border-radius: 4px; }
  button:hover { background: #003366; }
  .error { color: red; margin-top: -0.5rem; margin-bottom: 0.5rem; }
  .hidden { display: none; }
  #dashboard, #adminPanel { margin-top: 2rem; }
  #transactionHistory { max-height: 200px; overflow-y: auto; border: 1px solid #ccc; padding: 0.5rem; border-radius: 4px; background: #f9f9f9; }
  table { width: 100%; border-collapse: collapse; margin-top: 0.5rem; }
  th, td { border: 1px solid #ccc; padding: 0.3rem 0.5rem; text-align: left; font-size: 0.9rem; }
  th { background: #e6f0ff; }
  #logoutBtn { float: right; background: #cc0000; }
  #logoutBtn:hover { background: #990000; }
  small { color: #666; }
  .otp-section { margin-top: 1rem; padding: 0.8rem; background: #eef5ff; border-radius: 4px; }
  .file-preview { margin-top: 0.5rem; font-size: 0.85rem; color: #333; }
</style>
</head>
<body>
<header>
  <h1>Fintech Wallet Platform</h1>
</header>
<main>

  <!-- REGISTER -->
  <section id="registerSection">
    <h2>Register New Account</h2>
    <form id="registerForm" enctype="multipart/form-data" autocomplete="off" novalidate>
      <div>
        <label for="surname">Surname *</label>
        <input type="text" id="surname" required />
      </div>
      <div>
        <label for="middleName">Middle Name (optional)</label>
        <input type="text" id="middleName" />
      </div>
      <div>
        <label for="firstName">First Name *</label>
        <input type="text" id="firstName" required />
      </div>
      <div>
        <label for="idNumber">ID / Passport Number *</label>
        <input type="text" id="idNumber" required pattern=".{6,}" title="Minimum 6 characters" />
      </div>
      <div>
        <label for="phone">Phone Number (for SMS OTP) *</label>
        <input type="tel" id="phone" required pattern="^\+?\d{7,15}$" placeholder="+1234567890" />
      </div>
      <div>
        <label for="email">Email Address *</label>
        <input type="email" id="email" required />
      </div>
      <div>
        <label for="password">Password *</label>
        <input type="password" id="password" required minlength="6" />
      </div>
      <div>
        <label for="pin">4-Digit PIN *</label>
        <input type="password" id="pin" required pattern="\d{4}" title="Exactly 4 digits" maxlength="4" />
      </div>
      <div>
        <label for="selfieUpload">Upload Live Selfie *</label>
        <input type="file" id="selfieUpload" accept="image/*" required />
        <div id="selfiePreview" class="file-preview"></div>
      </div>
      <div>
        <label for="idUpload">Upload ID/Passport Scan *</label>
        <input type="file" id="idUpload" accept="image/*,application/pdf" required />
        <div id="idPreview" class="file-preview"></div>
      </div>
      <div>
        <button type="submit">Register</button>
      </div>
      <div id="registerError" class="error"></div>
    </form>
  </section>

  <!-- OTP Verification -->
  <section id="otpSection" class="hidden">
    <h2>OTP Verification</h2>
    <p>We have sent OTP codes to your phone and email. (Simulation)</p>
    <div class="otp-section">
      <label for="otpPhone">Enter OTP from SMS *</label>
      <input type="text" id="otpPhone" maxlength="6" pattern="\d{6}" required />
    </div>
    <div class="otp-section">
      <label for="otpEmail">Enter OTP from Email *</label>
      <input type="text" id="otpEmail" maxlength="6" pattern="\d{6}" required />
    </div>
    <div>
      <button id="verifyOtpBtn">Verify OTP</button>
    </div>
    <div id="otpError" class="error"></div>
  </section>

  <!-- LOGIN -->
  <section id="loginSection">
    <h2>Login</h2>
    <form id="loginForm" autocomplete="off" novalidate>
      <div>
        <label for="loginUsername">Username (Wallet Number or ID Number)</label>
        <input type="text" id="loginUsername" required />
      </div>
      <div>
        <label for="loginPassword">Password</label>
        <input type="password" id="loginPassword" required />
      </div>
      <div>
        <button type="submit">Login</button>
      </div>
      <div id="loginError" class="error"></div>
    </form>
  </section>

  <!-- DASHBOARD -->
  <section id="dashboard" class="hidden">
    <h2>Welcome, <span id="userFullName"></span></h2>
    <button id="logoutBtn">Logout</button>

    <p><strong>Wallet Number:</strong> <span id="walletNumber"></span></p>
    <p><strong>Balance:</strong> KES <span id="walletBalance"></span></p>

    <h3>Send Money</h3>
    <form id="sendMoneyForm" autocomplete="off" novalidate>
      <div>
        <label for="recipientWallet">Recipient Wallet Number *</label>
        <input type="text" id="recipientWallet" required />
      </div>
      <div>
        <label>Recipient Name</label>
        <input type="text" id="recipientName" disabled />
      </div>
      <div>
        <label for="sendAmount">Amount to Send (KES) *</label>
        <input type="number" id="sendAmount" min="1" required />
      </div>
      <div>
        <label for="authPin">Enter your 4-digit PIN *</label>
        <input type="password" id="authPin" pattern="\d{4}" maxlength="4" required />
      </div>
      <div>
        <button type="submit">Send</button>
      </div>
      <div id="sendMoneyError" class="error"></div>
      <div id="sendMoneySuccess" style="color:green; margin-top:0.5rem;"></div>
    </form>

    <h3>Transaction History</h3>
    <div id="transactionHistory">
      <table>
        <thead><tr><th>Date</th><th>Type</th><th>Details</th><th>Amount (KES)</th><th>Charge (KES)</th><th>Balance After</th></tr></thead>
        <tbody id="transactionLogBody"></tbody>
      </table>
    </div>
  </section>

  <!-- ADMIN PANEL -->
  <section id="adminPanel" class="hidden">
    <h2>Admin Panel</h2>
    <button id="adminLogoutBtn">Logout</button>
    <h3>All Users & Wallets</h3>
    <table>
      <thead><tr><th>Wallet Number</th><th>Full Name</th><th>ID Number</th><th>Phone</th><th>Email</th><th>Balance</th></tr></thead>
      <tbody id="allUsersBody"></tbody>
    </table>
    <h3>All Transactions</h3>
    <div style="max-height:300px; overflow-y:auto;">
      <table>
        <thead><tr><th>Date</th><th>Sender</th><th>Recipient</th><th>Amount</th><th>Charge</th><th>Status</th></tr></thead>
        <tbody id="allTransactionsBody"></tbody>
      </table>
    </div>
  </section>

</main>

<script>
(() => {
  // Constants
  const TRANSACTION_CHARGE_RATE = 0.02; // 2% charge
  const TRANSACTION_CHARGE_CAP = 1000; // Max charge KES 1000
  const DUPLICATE_TIMEFRAME = 60000; // 1 minute in ms

  // State variables
  let users = {};
  let transactions = [];
  let currentUser = null;
  let pendingRegistration = null; // Store form data before OTP verification
  let simulatedOtpPhone = null;
  let simulatedOtpEmail = null;

  // Hardcoded users on first load - ONLY if no data in localStorage
  function initHardcodedUsers() {
    if (localStorage.getItem('users')) return;

    const baseUsers = {
      "100000001": {
        walletNumber: "100000001",
        surname: "Kilush",
        middleName: "",
        firstName: "",
        idNumber: "A123456",
        phone: "+254700000001",
        email: "kilush@example.com",
        password: "password1",
        pin: "1234",
        selfie: null,
        idScan: null,
        balance: 100000,
        kycCompleted: true,
        isAdmin: false,
        transactionLog: []
      },
      "100000002": {
        walletNumber: "100000002",
        surname: "Schwadz",
        middleName: "",
        firstName: "",
        idNumber: "B654321",
        phone: "+254700000002",
        email: "schwadz@example.com",
        password: "password2",
        pin: "2345",
        selfie: null,
        idScan: null,
        balance: 50000,
        kycCompleted: true,
        isAdmin: false,
        transactionLog: []
      },
      "999999999": {
        walletNumber: "999999999",
        surname: "Admin",
        middleName: "",
        firstName: "User",
        idNumber: "ADMIN000",
        phone: "+254700000000",
        email: "admin@example.com",
        password: "adminpass",
        pin: "0000",
        selfie: null,
        idScan: null,
        balance: 0,
        kycCompleted: true,
        isAdmin: true,
        transactionLog: []
      }
    };
    users = baseUsers;
    saveUsers();
  }

  // Save and Load users & transactions to localStorage for persistence demo
  function saveUsers() {
    localStorage.setItem('users', JSON.stringify(users));
  }
  function loadUsers() {
    const data = localStorage.getItem('users');
    if (data) users = JSON.parse(data);
  }
  function saveTransactions() {
    localStorage.setItem('transactions', JSON.stringify(transactions));
  }
  function loadTransactions() {
    const data = localStorage.getItem('transactions');
    if (data) transactions = JSON.parse(data);
  }

  // Utility: Generate unique wallet number (9 digits starting with 1 or 9 for admin)
  function generateWalletNumber() {
    let num;
    do {
      num = '1' + Math.floor(10000000 + Math.random() * 90000000).toString();
    } while(users[num]);
    return num;
  }

  // Utility: format full name
  function getFullName(user) {
    return [user.surname, user.middleName, user.firstName].filter(Boolean).join(' ');
  }

  // Utility: Validate registration form inputs (basic)
  function validateRegistrationForm() {
    const surname = document.getElementById('surname').value.trim();
    const firstName = document.getElementById('firstName').value.trim();
    const idNumber = document.getElementById('idNumber').value.trim();
    const phone = document.getElementById('phone').value.trim();
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;
    const pin = document.getElementById('pin').value;
    const selfieUpload = document.getElementById('selfieUpload').files[0];
    const idUpload = document.getElementById('idUpload').files[0];

    if (!surname || !firstName || !idNumber || !phone || !email || !password || !pin || !selfieUpload || !idUpload) {
      return "All required fields must be filled and files uploaded.";
    }
    if (!/^\+?\d{7,15}$/.test(phone)) {
      return "Phone number format is invalid.";
    }
    if (password.length < 6) {
      return "Password must be at least 6 characters.";
    }
    if (!/^\d{4}$/.test(pin)) {
      return "PIN must be exactly 4 digits.";
    }
    if (usersHasIdNumber(idNumber)) {
      return "ID / Passport number already registered.";
    }
    return null;
  }

  // Check if ID number already registered
  function usersHasIdNumber(idNumber) {
    return Object.values(users).some(u => u.idNumber.toLowerCase() === idNumber.toLowerCase());
  }

  // Convert File to Base64 string (for demo storage)
  function fileToBase64(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.onerror = err => reject(err);
      reader.readAsDataURL(file);
    });
  }

  // Handle preview of uploaded files
  function previewFile(inputId, previewId) {
    const input = document.getElementById(inputId);
    const preview = document.getElementById(previewId);
    if (input.files.length > 0) {
      preview.textContent = input.files[0].name;
    } else {
      preview.textContent = '';
    }
  }

  // Simulate sending OTP (generate random 6 digit)
  function simulateSendOtp() {
    simulatedOtpPhone = Math.floor(100000 + Math.random() * 900000).toString();
    simulatedOtpEmail = Math.floor(100000 + Math.random() * 900000).toString();
    console.log("Simulated OTP Phone:", simulatedOtpPhone);
    console.log("Simulated OTP Email:", simulatedOtpEmail);
  }

  // Show/hide sections helper
  function showSection(id) {
    ['registerSection','otpSection','loginSection','dashboard','adminPanel'].forEach(sid => {
      document.getElementById(sid).classList.add('hidden');
    });
    document.getElementById(id).classList.remove('hidden');
  }

  // Auto-fill recipient name on send money form when wallet number entered
  function setupRecipientAutoFill() {
    const recipientInput = document.getElementById('recipientWallet');
    const recipientNameInput = document.getElementById('recipientName');

    recipientInput.addEventListener('input', () => {
      const val = recipientInput.value.trim();
      if (users[val]) {
        recipientNameInput.value = getFullName(users[val]);
      } else {
        recipientNameInput.value = '';
      }
    });
  }

  // Register form submit handler
  async function onRegisterSubmit(e) {
    e.preventDefault();
    const errorDiv = document.getElementById('registerError');
    errorDiv.textContent = '';

    const validationError = validateRegistrationForm();
    if (validationError) {
      errorDiv.textContent = validationError;
      return;
    }

    // Read form values
    const surname = document.getElementById('surname').value.trim();
    const middleName = document.getElementById('middleName').value.trim();
    const firstName = document.getElementById('firstName').value.trim();
    const idNumber = document.getElementById('idNumber').
