<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Universal Wallet Platform</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f2f2f2;
      margin: 0;
      padding: 0;
    }
    .container {
      width: 100%;
      max-width: 600px;
      margin: 30px auto;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
    }
    h2, h3 {
      text-align: center;
    }
    input, button, select {
      display: block;
      width: 100%;
      padding: 10px;
      margin: 10px 0;
    }
    .hidden {
      display: none;
    }
    .logout-btn {
      background: crimson;
      color: white;
      margin-top: 20px;
    }
    canvas {
      margin: 10px auto;
      display: block;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Universal Wallet</h2>

    <div id="auth-section">
      <h3>Register</h3>
      <input type="text" id="regName" placeholder="Full Name">
      <input type="text" id="regWallet" placeholder="Wallet Number">
      <input type="password" id="regPin" placeholder="PIN (4 digits)">
      <select id="regRole">
        <option value="user">User</option>
        <option value="admin">Admin</option>
      </select>
      <button onclick="register()">Register</button>

      <h3>Login</h3>
      <input type="text" id="loginWallet" placeholder="Wallet Number">
      <input type="password" id="loginPin" placeholder="PIN">
      <button onclick="login()">Login</button>
    </div>

    <div id="user-dashboard" class="hidden">
      <h3>Welcome, <span id="user-name"></span></h3>
      <p><strong>Wallet:</strong> <span id="user-wallet"></span></p>
      <p><strong>Balance:</strong> KES <span id="user-balance"></span></p>

      <h4>Transfer Money</h4>
      <input type="text" id="recipientWallet" placeholder="Recipient Wallet">
      <input type="number" id="transferAmount" placeholder="Amount to Send (KES)">
      <button onclick="previewTransfer()">Preview Recipient</button>
      <p id="recipientName"></p>
      <input type="password" id="confirmPin" placeholder="Enter your PIN to Confirm">
      <button onclick="transferMoney()">Send</button>

      <button class="logout-btn" onclick="logout()">Logout</button>
    </div>

    <div id="admin-dashboard" class="hidden">
      <h3>Admin Dashboard</h3>
      <p><strong>Admin:</strong> <span id="admin-name"></span></p>

      <p>Total Registered Users: <span id="total-users"></span></p>
      <canvas id="transactionGraph" width="400" height="200"></canvas>
      <canvas id="chargeGraph" width="400" height="200"></canvas>

      <button class="logout-btn" onclick="logout()">Logout</button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    let users = JSON.parse(localStorage.getItem('users') || '[]');
    let currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
    let transactions = JSON.parse(localStorage.getItem('transactions') || '[]');

    function saveAll() {
      localStorage.setItem('users', JSON.stringify(users));
      localStorage.setItem('transactions', JSON.stringify(transactions));
    }

    function register() {
      const name = document.getElementById('regName').value;
      const wallet = document.getElementById('regWallet').value;
      const pin = document.getElementById('regPin').value;
      const role = document.getElementById('regRole').value;

      if (users.some(u => u.wallet === wallet)) return alert('Wallet already registered');
      if (pin.length !== 4) return alert('PIN must be 4 digits');

      users.push({ name, wallet, pin, role, balance: 10000 });
      saveAll();
      alert('Registration successful!');
    }

    function login() {
      const wallet = document.getElementById('loginWallet').value;
      const pin = document.getElementById('loginPin').value;

      const user = users.find(u => u.wallet === wallet && u.pin === pin);
      if (!user) return alert('Invalid login');

      localStorage.setItem('currentUser', JSON.stringify(user));
      location.reload();
    }

    function logout() {
      localStorage.removeItem('currentUser');
      location.reload();
    }

    function previewTransfer() {
      const wallet = document.getElementById('recipientWallet').value;
      const recipient = users.find(u => u.wallet === wallet);
      document.getElementById('recipientName').textContent = recipient ? `Name: ${recipient.name}` : 'Recipient not found';
    }

    function transferMoney() {
      const sender = JSON.parse(localStorage.getItem('currentUser'));
      const recipientWallet = document.getElementById('recipientWallet').value;
      const amount = parseFloat(document.getElementById('transferAmount').value);
      const pin = document.getElementById('confirmPin').value;

      if (sender.pin !== pin) return alert('Invalid PIN');
      if (recipientWallet === sender.wallet) return alert('Cannot send to yourself');
      if (!amount || amount <= 0) return alert('Invalid amount');

      const recipient = users.find(u => u.wallet === recipientWallet);
      if (!recipient) return alert('Recipient not found');

      const duplicate = transactions.find(t =>
        t.from === sender.wallet &&
        t.to === recipient.wallet &&
        t.amount === amount &&
        Date.now() - t.timestamp < 60000
      );
      if (duplicate) return alert('Duplicate transaction blocked');

      const charge = Math.min(amount * 0.01, 1000);
      const total = amount + charge;
      const senderUser = users.find(u => u.wallet === sender.wallet);

      if (senderUser.balance < total) return alert('Insufficient balance');

      senderUser.balance -= total;
      recipient.balance += amount;
      transactions.push({ from: sender.wallet, to: recipient.wallet, amount, charge, timestamp: Date.now() });

      saveAll();
      localStorage.setItem('currentUser', JSON.stringify(senderUser));
      alert(`KES ${amount} sent to ${recipient.name}. KES ${charge} charged.`);

      location.reload();
    }

    function showDashboard() {
      if (!currentUser) return;

      document.getElementById('auth-section').classList.add('hidden');

      if (currentUser.role === 'user') {
        const user = users.find(u => u.wallet === currentUser.wallet);
        document.getElementById('user-name').textContent = user.name;
        document.getElementById('user-wallet').textContent = user.wallet;
        document.getElementById('user-balance').textContent = user.balance.toFixed(2);
        document.getElementById('user-dashboard').classList.remove('hidden');
      }

      if (currentUser.role === 'admin') {
        document.getElementById('admin-name').textContent = currentUser.name;
        document.getElementById('total-users').textContent = users.length;
        document.getElementById('admin-dashboard').classList.remove('hidden');
        drawCharts();
      }
    }

    function drawCharts() {
      const ctx1 = document.getElementById('transactionGraph').getContext('2d');
      const ctx2 = document.getElementById('chargeGraph').getContext('2d');

      const currencies = ['KES'];
      const totals = [transactions.reduce((sum, t) => sum + t.amount, 0)];
      const charges = [transactions.reduce((sum, t) => sum + t.charge, 0)];

      new Chart(ctx1, {
        type: 'bar',
        data: {
          labels: currencies,
          datasets: [{ label: 'Total Sent', data: totals, backgroundColor: 'blue' }]
        }
      });

      new Chart(ctx2, {
        type: 'bar',
        data: {
          labels: currencies,
          datasets: [{ label: 'Charges', data: charges, backgroundColor: 'green' }]
        }
      });
    }

    showDashboard();
  </script>
</body>
</html>
