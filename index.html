<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Wallet Platform</title>
  <style>
    body { font-family: Arial; padding: 20px; background: #f4f4f4; }
    .hidden { display: none; }
    .box { background: white; padding: 20px; border-radius: 10px; max-width: 500px; margin: auto; }
    input, button { display: block; width: 100%; padding: 10px; margin: 10px 0; }
    .dashboard { max-width: 800px; margin: auto; }
    .logout-btn { background-color: #f44336; color: white; }
  </style>
</head>
<body>

  <!-- START PAGE -->
  <div id="startPage" class="box">
    <h2>Welcome to Wallet Platform</h2>
    <button onclick="showLogin()">Login</button>
    <button onclick="showRegister()">Register</button>
  </div>

  <!-- LOGIN PAGE -->
  <div id="loginPage" class="box hidden">
    <h2>Login</h2>
    <input id="loginUsername" placeholder="Username" />
    <input id="loginPassword" type="password" placeholder="Password" />
    <button onclick="login()">Log In</button>
    <button onclick="showStart()">Back</button>
  </div>

  <!-- REGISTER PAGE -->
  <div id="registerPage" class="box hidden">
    <h2>Register</h2>
    <input id="regSurname" placeholder="Surname" />
    <input id="regMiddle" placeholder="Middle Name (optional)" />
    <input id="regFirst" placeholder="First Name" />
    <input id="regID" placeholder="ID/Passport Number" />
    <input id="regPhone" placeholder="Phone Number" />
    <input id="regEmail" placeholder="Email Address" />
    <input id="regPassword" type="password" placeholder="Password" />
    <input id="regPin" type="password" placeholder="Transaction PIN" />
    <button onclick="register()">Register</button>
    <button onclick="showStart()">Back</button>
  </div>

  <!-- USER DASHBOARD -->
  <div id="userDashboard" class="dashboard hidden">
    <h2>User Dashboard</h2>
    <div id="userInfo"></div>
    <input id="recipientWallet" placeholder="Recipient Wallet Number" />
    <input id="amount" placeholder="Amount" />
    <input id="confirmPin" type="password" placeholder="Enter PIN" />
    <button onclick="transfer()">Send Money</button>
    <h3>Transaction Log:</h3>
    <pre id="transactionLog"></pre>
    <button onclick="logout()" class="logout-btn">Logout</button>
  </div>

  <!-- ADMIN DASHBOARD -->
  <div id="adminDashboard" class="dashboard hidden">
    <h2>Admin Dashboard</h2>
    <div id="adminView"></div>
    <button onclick="logout()" class="logout-btn">Logout</button>
  </div>

<script>
  const users = {
    admin: { password: "admin123", pin: "0000", balance: 1000000, wallet: "ADM001", role: "admin", name: "Administrator" },
    kilush: { password: "pass123", pin: "1111", balance: 5000, wallet: "KIL001", role: "user", name: "Kilush Kamau" },
    schwadz: { password: "pass123", pin: "2222", balance: 7500, wallet: "SCH001", role: "user", name: "Schwadz M" },
    moses: { password: "pass123", pin: "3333", balance: 3000, wallet: "MOS001", role: "user", name: "Moses L" }
  };

  const walletToUser = {};
  for (let u in users) {
    walletToUser[users[u].wallet] = u;
  }

  let currentUser = null;
  let transactionLog = [];

  // AUTO LOGIN IF SESSION EXISTS
  window.onload = () => {
    const saved = sessionStorage.getItem("loggedUser");
    if (saved && users[saved]) {
      currentUser = saved;
      showDashboard();
    } else {
      showStart();
    }
  };

  function showStart() {
    hideAll();
    document.getElementById("startPage").classList.remove("hidden");
  }

  function showLogin() {
    hideAll();
    document.getElementById("loginPage").classList.remove("hidden");
  }

  function showRegister() {
    hideAll();
    document.getElementById("registerPage").classList.remove("hidden");
  }

  function hideAll() {
    document.querySelectorAll(".box, .dashboard").forEach(el => el.classList.add("hidden"));
  }

  function login() {
    const username = document.getElementById("loginUsername").value.trim();
    const password = document.getElementById("loginPassword").value.trim();
    if (users[username] && users[username].password === password) {
      currentUser = username;
      sessionStorage.setItem("loggedUser", username);
      showDashboard();
    } else {
      alert("Invalid login.");
    }
  }

  function register() {
    const surname = document.getElementById("regSurname").value.trim();
    const middle = document.getElementById("regMiddle").value.trim();
    const first = document.getElementById("regFirst").value.trim();
    const id = document.getElementById("regID").value.trim();
    const phone = document.getElementById("regPhone").value.trim();
    const email = document.getElementById("regEmail").value.trim();
    const password = document.getElementById("regPassword").value.trim();
    const pin = document.getElementById("regPin").value.trim();

    if (!surname || !first || !id || !phone || !email || !password || !pin) {
      return alert("All required fields must be filled.");
    }

    const username = id;
    if (users[username]) {
      return alert("User already exists.");
    }

    const wallet = "USR" + Math.floor(1000 + Math.random() * 9000);
    users[username] = {
      password,
      pin,
      balance: 0,
      wallet,
      role: "user",
      name: `${surname} ${middle} ${first}`.trim()
    };
    walletToUser[wallet] = username;
    alert(`Registration successful! Your username is ${username}`);
    showLogin();
  }

  function showDashboard() {
    hideAll();
    const user = users[currentUser];
    if (!user) return;

    if (user.role === "admin") {
      document.getElementById("adminDashboard").classList.remove("hidden");
      let html = "<h3>All Users</h3><ul>";
      for (let u in users) {
        html += `<li><b>${u}</b> - ${users[u].wallet} - ${users[u].balance} KES</li>`;
      }
      html += "</ul>";
      document.getElementById("adminView").innerHTML = html;
    } else {
      document.getElementById("userDashboard").classList.remove("hidden");
      document.getElementById("userInfo").innerHTML = `
        <b>Name:</b> ${user.name}<br>
        <b>Wallet:</b> ${user.wallet}<br>
        <b>Balance:</b> ${user.balance.toFixed(2)} KES
      `;
      displayTransactionLog();
    }
  }

  function logout() {
    currentUser = null;
    sessionStorage.removeItem("loggedUser");
    showStart();
  }

  function transfer() {
    const sender = users[currentUser];
    const recipientWallet = document.getElementById("recipientWallet").value.trim();
    const amount = parseFloat(document.getElementById("amount").value.trim());
    const pin = document.getElementById("confirmPin").value.trim();

    if (!walletToUser[recipientWallet]) return alert("Invalid wallet.");
    if (recipientWallet === sender.wallet) return alert("Cannot send to your own wallet.");
    if (pin !== sender.pin) return alert("Incorrect PIN.");
    if (isNaN(amount) || amount <= 0) return alert("Enter a valid amount.");

    const recipient = users[walletToUser[recipientWallet]];
    const now = Date.now();
    const last = sender.lastTx || 0;

    // Block duplicate transfer in 1 minute
    if (now - last < 60000 && sender.lastDetails === `${recipientWallet}-${amount}`) {
      return alert("Wait a minute before repeating this transfer.");
    }

    let fee = Math.min(Math.ceil(amount * 0.01), 1000);
    if (sender.balance < amount + fee) return alert("Insufficient funds (amount + fee).");

    sender.balance -= amount + fee;
    recipient.balance += amount;

    sender.lastTx = now;
    sender.lastDetails = `${recipientWallet}-${amount}`;

    transactionLog.push(`${sender.name} sent ${amount} KES to ${recipient.name}. Fee: ${fee} KES`);
    alert("Transfer successful!");
    showDashboard();
  }

  function displayTransactionLog() {
    document.getElementById("transactionLog").textContent = transactionLog.join("\n");
  }
</script>
</body>
</html>
