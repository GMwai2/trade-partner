<!DOCTYPE html>
<html>
<head>
    <title>Wallet Platform</title>
    <style>
        body { font-family: Arial; margin: 40px; background: #f2f2f2; }
        #login, #dashboard { max-width: 500px; margin: auto; padding: 20px; background: #fff; border-radius: 8px; box-shadow: 0 0 10px #aaa; }
        input, button { width: 100%; padding: 10px; margin: 8px 0; }
        .hidden { display: none; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
    </style>
</head>
<body>

<div id="login">
    <h2>Login</h2>
    <input type="text" id="username" placeholder="Username" />
    <input type="password" id="password" placeholder="Password" />
    <button onclick="login()">Login</button>
    <p id="login-error" style="color:red;"></p>
</div>

<div id="dashboard" class="hidden">
    <h2>Welcome, <span id="userDisplay"></span></h2>
    <p><b>Wallet No:</b> <span id="walletNumber"></span></p>
    <p><b>Balance:</b> KES <span id="balance"></span></p>

    <h3>Send Money</h3>
    <input type="text" id="recipientWallet" placeholder="Recipient Wallet No" />
    <input type="number" id="amount" placeholder="Amount" />
    <input type="password" id="pin" placeholder="Enter PIN" />
    <button onclick="transfer()">Send</button>
    <p id="transfer-msg" style="color:green;"></p>

    <h3>Transaction History</h3>
    <table>
        <thead>
            <tr><th>To</th><th>Amount</th><th>Charge</th><th>Time</th></tr>
        </thead>
        <tbody id="txnTable"></tbody>
    </table>

    <br />
    <button onclick="logout()">Logout</button>
</div>

<script>
    const users = {
        schwadz: { password: "pass123", pin: "1111", balance: 10000, wallet: "WLT001" },
        kilush: { password: "pass456", pin: "2222", balance: 8000, wallet: "WLT002" },
        admin: { password: "admin123", pin: "0000", balance: 15000, wallet: "ADMIN001" }
    };

    let currentUser = null;
    let lastTx = null;

    function login() {
        const u = document.getElementById("username").value.trim().toLowerCase();
        const p = document.getElementById("password").value.trim();
        const err = document.getElementById("login-error");

        if (users[u] && users[u].password === p) {
            currentUser = u;
            document.getElementById("login").classList.add("hidden");
            document.getElementById("dashboard").classList.remove("hidden");
            document.getElementById("userDisplay").textContent = u;
            document.getElementById("walletNumber").textContent = users[u].wallet;
            updateBalance();
            loadTransactions();
        } else {
            err.textContent = "Invalid credentials";
        }
    }

    function updateBalance() {
        document.getElementById("balance").textContent = users[currentUser].balance;
    }

    function logout() {
        currentUser = null;
        document.getElementById("dashboard").classList.add("hidden");
        document.getElementById("login").classList.remove("hidden");
        document.getElementById("username").value = "";
        document.getElementById("password").value = "";
        document.getElementById("login-error").textContent = "";
    }

    function transfer() {
        const recipientWallet = document.getElementById("recipientWallet").value.trim().toUpperCase();
        const amount = parseFloat(document.getElementById("amount").value.trim());
        const pin = document.getElementById("pin").value.trim();
        const msg = document.getElementById("transfer-msg");
        msg.textContent = "";

        if (!recipientWallet || isNaN(amount) || amount <= 0 || !pin) {
            msg.style.color = "red"; msg.textContent = "All fields are required and valid.";
            return;
        }

        if (users[currentUser].pin !== pin) {
            msg.style.color = "red"; msg.textContent = "Incorrect PIN.";
            return;
        }

        const charge = Math.min(amount * 0.02, 1000);
        const total = amount + charge;

        if (users[currentUser].balance < total) {
            msg.style.color = "red"; msg.textContent = "Insufficient funds including charges.";
            return;
        }

        const now = Date.now();
        if (lastTx && now - lastTx.time < 60000 && lastTx.to === recipientWallet && lastTx.amount === amount) {
            msg.style.color = "red"; msg.textContent = "Duplicate transaction blocked (try after 1 minute).";
            return;
        }

        let recipient = Object.keys(users).find(u => users[u].wallet === recipientWallet);
        if (!recipient) {
            msg.style.color = "red"; msg.textContent = "Recipient wallet not found.";
            return;
        }

        users[currentUser].balance -= total;
        users[recipient].balance += amount;
        updateBalance();

        const txn = { to: recipientWallet, amount, charge, time: new Date().toLocaleTimeString() };
        let txns = JSON.parse(localStorage.getItem(currentUser + "_txns") || "[]");
        txns.push(txn);
        localStorage.setItem(currentUser + "_txns", JSON.stringify(txns));
        lastTx = { ...txn, time: now };

        document.getElementById("recipientWallet").value = "";
        document.getElementById("amount").value = "";
        document.getElementById("pin").value = "";

        msg.style.color = "green"; msg.textContent = "Transfer successful!";
        loadTransactions();
    }

    function loadTransactions() {
        const txns = JSON.parse(localStorage.getItem(currentUser + "_txns") || "[]");
        const tbody = document.getElementById("txnTable");
        tbody.innerHTML = "";
        txns.slice().reverse().forEach(txn => {
            const row = `<tr><td>${txn.to}</td><td>KES ${txn.amount}</td><td>KES ${txn.charge}</td><td>${txn.time}</td></tr>`;
            tbody.innerHTML += row;
        });
    }
</script>
</body>
</html>
