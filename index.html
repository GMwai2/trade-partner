<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Wallet Transfer Platform</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 600px; margin: 20px auto; }
    input, select, button { display: block; margin: 10px 0; padding: 8px; width: 100%; max-width: 300px; }
    #recipientDetails { margin-top: 10px; }
  </style>
</head>
<body>

<!-- Login Section -->
<div id="loginSection">
  <h2>Login</h2>
  <input type="text" id="loginUsername" placeholder="Username" />
  <input type="password" id="loginPassword" placeholder="Password" />
  <button onclick="login()">Login</button>
  <p>No account? <a href="#" onclick="showRegister()">Register here</a></p>
</div>

<!-- Registration Section -->
<div id="registerSection" style="display:none;">
  <h2>Register</h2>
  <input type="text" id="regName" placeholder="Full Name" />
  <input type="text" id="regUsername" placeholder="Username" />
  <input type="password" id="regPassword" placeholder="Password" />
  <input type="text" id="regPin" placeholder="4-digit PIN" maxlength="4" />
  <select id="regCurrency">
    <option value="KES">KES</option>
    <option value="USD">USD</option>
    <option value="EUR">EUR</option>
    <option value="JPY">JPY</option>
  </select>
  <button onclick="register()">Register</button>
  <p>Have account? <a href="#" onclick="showLogin()">Login here</a></p>
</div>

<!-- Dashboard Section -->
<div id="dashboard" style="display:none;">
  <h2 id="welcomeMsg"></h2>
  <p><strong>Wallet Number:</strong> <span id="walletNum"></span></p>
  <p><strong>Balance:</strong> <span id="balance"></span></p>

  <h3>Make a Transfer</h3>
  <label for="transferType">Transfer Type:</label>
  <select id="transferType" onchange="updateTransferForm()">
    <option value="wallet">Other Wallet (platform)</option>
    <option value="mobile">Mobile Banking</option>
    <option value="bank">Bank Account</option>
  </select>

  <div id="transferForm"></div>
  <button onclick="submitTransfer()">Send</button>
  <button onclick="logout()" style="margin-top:20px;">Logout</button>
</div>

<script>
  const exchangeRates = { KES: 1, USD: 145, EUR: 160, JPY: 1.1 };
  let users = JSON.parse(localStorage.getItem("users") || "{}");

  function saveUsers() {
    localStorage.setItem("users", JSON.stringify(users));
  }

  function showLogin() {
    document.getElementById("loginSection").style.display = "block";
    document.getElementById("registerSection").style.display = "none";
    document.getElementById("dashboard").style.display = "none";
  }

  function showRegister() {
    document.getElementById("loginSection").style.display = "none";
    document.getElementById("registerSection").style.display = "block";
    document.getElementById("dashboard").style.display = "none";
  }

  function showDashboard() {
    const username = sessionStorage.getItem("loggedInUser");
    if (!username || !users[username]) return showLogin();
    const user = users[username];

    document.getElementById("loginSection").style.display = "none";
    document.getElementById("registerSection").style.display = "none";
    document.getElementById("dashboard").style.display = "block";

    document.getElementById("welcomeMsg").innerText = `Welcome, ${user.name}`;
    document.getElementById("walletNum").innerText = user.walletNumber;
    document.getElementById("balance").innerText = `${user.balance.toFixed(2)} ${user.currency}`;
    updateTransferForm();
  }

  function login() {
    const username = document.getElementById("loginUsername").value.trim().toLowerCase();
    const password = document.getElementById("loginPassword").value;
    if (!username || !password || !users[username] || users[username].password !== password) {
      return alert("Invalid username or password");
    }
    sessionStorage.setItem("loggedInUser", username);
    showDashboard();
  }

  function register() {
    const name = document.getElementById("regName").value.trim();
    const username = document.getElementById("regUsername").value.trim().toLowerCase();
    const password = document.getElementById("regPassword").value;
    const pin = document.getElementById("regPin").value;
    const currency = document.getElementById("regCurrency").value;

    if (!name || !username || !password || !/^\d{4}$/.test(pin)) return alert("Fill all fields properly");
    if (users[username]) return alert("Username already exists");

    const walletNumber = "GALA" + Math.floor(1000 + Math.random() * 9000);
    users[username] = { name, password, pin, currency, walletNumber, balance: 0 };
    saveUsers();
    alert("Registration successful!");
    showLogin();
  }

  function logout() {
    sessionStorage.removeItem("loggedInUser");
    showLogin();
  }

  function updateTransferForm() {
    const type = document.getElementById("transferType").value;
    const formDiv = document.getElementById("transferForm");
    formDiv.innerHTML = "";

    if (type === "wallet") {
      formDiv.innerHTML = `
        <input type="text" id="recipientWallet" placeholder="Recipient Wallet Number" />
        <button type="button" onclick="loadRecipientDetails()">Load Recipient Details</button>
        <div id="recipientDetails"></div>
        <input type="number" id="transferAmount" placeholder="Amount to Send" min="1" />
        <input type="password" id="authPin" placeholder="Your 4-digit PIN" maxlength="4" />
      `;
    } else if (type === "mobile") {
      formDiv.innerHTML = `
        <input type="text" id="mobileNumber" placeholder="07XXXXXXXX" />
        <input type="number" id="transferAmount" placeholder="Amount to Send" min="1" />
        <input type="password" id="authPin" placeholder="Your 4-digit PIN" maxlength="4" />
      `;
    } else if (type === "bank") {
      formDiv.innerHTML = `
        <input type="text" id="bankAccountNumber" placeholder="Bank Account Number" />
        <input type="text" id="bankName" placeholder="Bank Name" />
        <input type="number" id="transferAmount" placeholder="Amount to Send" min="1" />
        <input type="password" id="authPin" placeholder="Your 4-digit PIN" maxlength="4" />
      `;
    }
  }

  function loadRecipientDetails() {
    const recipientWallet = document.getElementById("recipientWallet").value.trim().toUpperCase();
    const detailsDiv = document.getElementById("recipientDetails");
    const recipient = Object.values(users).find(u => u.walletNumber === recipientWallet);
    if (!recipient) {
      detailsDiv.innerHTML = "<p style='color:red;'>Recipient not found</p>";
    } else {
      detailsDiv.innerHTML = `
        <p><strong>Name:</strong> ${recipient.name}</p>
        <p><strong>Currency:</strong> ${recipient.currency}</p>
        <p><strong>Wallet Number:</strong> ${recipient.walletNumber}</p>
      `;
    }
  }

  function toKES(amount, currency) {
    return amount * (exchangeRates[currency] || 1);
  }

  function fromKES(kesAmount, currency) {
    return kesAmount / (exchangeRates[currency] || 1);
  }

  function submitTransfer() {
    const username = sessionStorage.getItem("loggedInUser");
    const user = users[username];
    const type = document.getElementById("transferType").value;
    const pin = document.getElementById("authPin")?.value.trim();
    const amount = Number(document.getElementById("transferAmount")?.value);

    if (!pin || pin !== user.pin || !amount || amount <= 0) return alert("Check PIN and amount");

    let chargeKES = Math.min(toKES(amount, user.currency) * 0.0075, 1000);
    let charge = fromKES(chargeKES, user.currency);
    let total = amount + charge;

    if (user.balance < total) return alert(`Insufficient balance. Need ${total.toFixed(2)} including fee.`);

    if (type === "wallet") {
      const walletID = document.getElementById("recipientWallet").value.trim().toUpperCase();
      if (walletID === user.walletNumber) return alert("Cannot send to your own wallet");
      const recipient = Object.values(users).find(u => u.walletNumber === walletID);
      if (!recipient) return alert("Recipient not found");

      user.balance -= total;
      recipient.balance += amount;
      alert(`Sent ${amount} ${user.currency}. Fee: ${charge.toFixed(2)} ${user.currency}`);

    } else if (type === "mobile") {
      const mobile = document.getElementById("mobileNumber").value.trim();
      if (!/^07\d{8}$/.test(mobile)) return alert("Invalid mobile number");
      user.balance -= total;
      alert(`Mobile transfer to ${mobile} simulated. Fee: ${charge.toFixed(2)} ${user.currency}`);

    } else if (type === "bank") {
      const acc = document.getElementById("bankAccountNumber").value.trim();
      const bank = document.getElementById("bankName").value.trim();
      if (!acc || !bank) return alert("Enter bank account and name");
      user.balance -= total;
      alert(`Bank transfer to ${acc} at ${bank} simulated. Fee: ${charge.toFixed(2)} ${user.currency}`);
    }

    saveUsers();
    showDashboard();
  }

  window.onload = function() {
    const user = sessionStorage.getItem("loggedInUser");
    if (user && users[user]) showDashboard();
    else showLogin();
  };
</script>
</body>
</html>
