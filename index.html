<script>
function populateCurrencies() {
  const currencySelect = document.getElementById("sendCurrency");
  currencySelect.innerHTML = "";
  for (const currency in users[currentUser].balances) {
    const option = document.createElement("option");
    option.value = currency;
    option.textContent = currency;
    currencySelect.appendChild(option);
  }
}

function updateBalances() {
  const user = users[currentUser];
  const balancesDiv = document.getElementById("balances");
  balancesDiv.innerHTML = "<h4>Balances</h4>";
  for (const [currency, amount] of Object.entries(user.balances)) {
    balancesDiv.innerHTML += `<p>${currency}: ${amount.toFixed(2)}</p>`;
  }
}

function sendMoney() {
  const recipientName = document.getElementById("recipientName").value.toLowerCase();
  const recipientWallet = document.getElementById("recipientWallet").value;
  const currency = document.getElementById("sendCurrency").value;
  const amount = parseFloat(document.getElementById("sendAmount").value);
  const pin = document.getElementById("authPin").value;
  const sender = users[currentUser];

  if (pin !== sender.pin) {
    document.getElementById("sendStatus").innerText = "Incorrect PIN.";
    return;
  }

  if (!amount || amount <= 0 || !currency) {
    document.getElementById("sendStatus").innerText = "Invalid amount or currency.";
    return;
  }

  if (sender.balances[currency] < amount) {
    document.getElementById("sendStatus").innerText = "Insufficient funds.";
    return;
  }

  // Find recipient
  let recipient = null;
  for (const user in users) {
    if (users[user].walletId === recipientWallet && users[user].name.toLowerCase() === recipientName) {
      recipient = users[user];
      break;
    }
  }

  if (!recipient) {
    document.getElementById("sendStatus").innerText = "Recipient not found or mismatched.";
    return;
  }

  let fee = 0;
  if (amount > 250) {
    fee = amount * 0.01;
    adminChargeWallet[currency] = (adminChargeWallet[currency] || 0) + fee;
  }

  const finalAmount = amount - fee;

  sender.balances[currency] -= amount;
  recipient.balances[currency] = (recipient.balances[currency] || 0) + finalAmount;

  const tx = {
    from: sender.name,
    to: recipient.name,
    currency,
    amount: finalAmount,
    fee,
    timestamp: new Date().toLocaleString()
  };

  sender.tx.push(tx);
  recipient.tx.push(tx);
  txLog.push(tx);

  updateBalances();
  renderTxHistory();
  document.getElementById("sendStatus").innerText = "Transfer complete.";
}

function renderTxHistory() {
  const user = users[currentUser];
  const list = document.getElementById("txHistory");
  list.innerHTML = "";
  user.tx.forEach(t => {
    list.innerHTML += `<li>${t.timestamp} - Sent ${t.amount} ${t.currency} to ${t.to} (Fee: ${t.fee || 0})</li>`;
  });
}

// Admin charts (basic text-based preview)
function showAdminDashboard() {
  document.getElementById("adminDashboard").classList.remove("hidden");
  document.getElementById("totalUsers").innerText = Object.keys(users).length - 1; // exclude admin
  document.getElementById("totalTx").innerText = txLog.length;

  const txGraph = document.getElementById("txGraph");
  const chargeGraph = document.getElementById("chargeGraph");
  const txByCurrency = {}, chargeByCurrency = {};

  txLog.forEach(t => {
    txByCurrency[t.currency] = (txByCurrency[t.currency] || 0) + t.amount;
    chargeByCurrency[t.currency] = (chargeByCurrency[t.currency] || 0) + (t.fee || 0);
  });

  txGraph.innerHTML = "";
  chargeGraph.innerHTML = "";
  for (const c in txByCurrency) {
    txGraph.innerHTML += `<p>${c}: ${txByCurrency[c].toFixed(2)}</p>`;
  }
  for (const c in chargeByCurrency) {
    chargeGraph.innerHTML += `<p>${c}: ${chargeByCurrency[c].toFixed(2)}</p>`;
  }

  document.getElementById("adminChargeWallet").innerText =
    `KES ${adminChargeWallet["KES"]?.toFixed(2) || "0.00"}`;
  document.getElementById("adminTradingWallet").innerText = "KES 0.00";
}

function createSubAdmin() {
  const uname = document.getElementById("subAdminUser").value.toLowerCase();
  const pwd = document.getElementById("subAdminPass").value;
  if (uname && pwd) {
    users[uname] = {
      name: uname.charAt(0).toUpperCase() + uname.slice(1),
      password: pwd,
      isAdmin: true,
      walletId: "SUBADMIN_" + uname.toUpperCase(),
      balances: {},
      tx: []
    };
    alert("Sub-admin created.");
  }
}
</script>
