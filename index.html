<!DOCTYPE html>
<html>
<head>
  <title>Wallet Platform</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial; padding: 20px; }
    #dashboard, #adminPanel { display: none; margin-top: 20px; }
    .hidden { display: none; }
    table, th, td { border: 1px solid #ccc; border-collapse: collapse; padding: 5px; }
    input { margin: 4px; padding: 5px; }
  </style>
</head>
<body>

<h2>Wallet Platform</h2>

<div id="authSection">
  <h3>Register</h3>
  <input placeholder="Surname" id="surname">
  <input placeholder="Middle Name" id="middlename">
  <input placeholder="First Name" id="firstname"><br>
  <input placeholder="ID/Passport" id="id">
  <input placeholder="Phone" id="phone">
  <input placeholder="Email" id="email"><br>
  <input placeholder="Password" id="password" type="password">
  <input placeholder="PIN" id="pin" type="password"><br>
  <button onclick="register()">Register</button>

  <h3>Login</h3>
  <input placeholder="ID/Passport" id="loginID">
  <input placeholder="Password" id="loginPass" type="password">
  <button onclick="login()">Login</button>
</div>

<div id="dashboard">
  <h3>Welcome, <span id="username"></span></h3>
  <p>Transaction Wallet: KES <span id="transactionWallet"></span></p>
  <p>Trading Wallet: KES <span id="tradingWallet"></span></p>

  <div id="adminPanel">
    <h3>Admin Panel</h3>
    <button onclick="transferAdminFunds()">Move Funds to Trading Wallet</button>
    <button onclick="exportKYC()">Export KYC to Excel</button>

    <canvas id="transactionChart" width="300"></canvas>
    <canvas id="tradingChart" width="300"></canvas>
  </div>

  <h4>Transaction History</h4>
  <table id="historyLog"><thead><tr><th>From</th><th>To</th><th>Amount</th><th>Type</th><th>Date</th></tr></thead><tbody></tbody></table>

  <button onclick="logout()">Logout</button>
</div>

<script>
let users = JSON.parse(localStorage.getItem("users")) || [];
let transactions = JSON.parse(localStorage.getItem("transactions")) || [];

function register() {
  let user = {
    surname: document.getElementById("surname").value,
    middlename: document.getElementById("middlename").value,
    firstname: document.getElementById("firstname").value,
    id: document.getElementById("id").value,
    phone: document.getElementById("phone").value,
    email: document.getElementById("email").value,
    password: document.getElementById("password").value,
    pin: document.getElementById("pin").value,
    transactionWallet: 0,
    tradingWallet: 0,
    username: document.getElementById("id").value
  };
  if (users.some(u => u.id === user.id)) return alert("User exists");
  users.push(user);
  localStorage.setItem("users", JSON.stringify(users));
  alert("Registered successfully!");
}

function login() {
  let id = document.getElementById("loginID").value;
  let pass = document.getElementById("loginPass").value;
  let user = users.find(u => u.id === id && u.password === pass);
  if (!user) return alert("Invalid credentials");

  sessionStorage.setItem("currentUser", JSON.stringify(user));
  document.getElementById("authSection").style.display = "none";
  document.getElementById("dashboard").style.display = "block";

  document.getElementById("username").innerText = user.firstname;
  document.getElementById("transactionWallet").innerText = user.transactionWallet;
  document.getElementById("tradingWallet").innerText = user.tradingWallet;

  if (user.id === "admin") {
    document.getElementById("adminPanel").style.display = "block";
    drawGraphs();
  }

  loadHistory(user.id);
}

function logout() {
  sessionStorage.removeItem("currentUser");
  document.getElementById("dashboard").style.display = "none";
  document.getElementById("authSection").style.display = "block";
}

function transferAdminFunds() {
  let user = JSON.parse(sessionStorage.getItem("currentUser"));
  let amount = prompt("Amount to move to trading wallet:");
  amount = parseFloat(amount);
  if (user.transactionWallet < amount) return alert("Insufficient funds");
  user.transactionWallet -= amount;
  user.tradingWallet += amount;

  logTransaction(user.id, "admin_trading", amount, "admin_move");

  updateUser(user);
  alert("Moved successfully!");
  location.reload();
}

function logTransaction(from, to, amount, type) {
  transactions.push({
    from, to, amount, type,
    date: new Date().toLocaleString()
  });
  localStorage.setItem("transactions", JSON.stringify(transactions));
}

function loadHistory(userID) {
  let tbody = document.querySelector("#historyLog tbody");
  tbody.innerHTML = "";
  transactions.filter(t => t.from === userID || t.to === userID)
    .forEach(t => {
      tbody.innerHTML += `<tr><td>${t.from}</td><td>${t.to}</td><td>${t.amount}</td><td>${t.type}</td><td>${t.date}</td></tr>`;
    });
}

function updateUser(user) {
  let i = users.findIndex(u => u.id === user.id);
  users[i] = user;
  localStorage.setItem("users", JSON.stringify(users));
  sessionStorage.setItem("currentUser", JSON.stringify(user));
}

function drawGraphs() {
  let ctx1 = document.getElementById("transactionChart").getContext("2d");
  let ctx2 = document.getElementById("tradingChart").getContext("2d");
  let admin = users.find(u => u.id === "admin");

  new Chart(ctx1, {
    type: 'bar',
    data: {
      labels: ["Transaction Wallet"],
      datasets: [{ label: 'KES', data: [admin.transactionWallet], backgroundColor: 'blue' }]
    }
  });

  new Chart(ctx2, {
    type: 'bar',
    data: {
      labels: ["Trading Wallet"],
      datasets: [{ label: 'KES', data: [admin.tradingWallet], backgroundColor: 'green' }]
    }
  });
}

function exportKYC() {
  let data = users.map(u => ({
    Surname: u.surname,
    MiddleName: u.middlename,
    FirstName: u.firstname,
    ID: u.id,
    Phone: u.phone,
    Email: u.email
  }));
  let ws = XLSX.utils.json_to_sheet(data);
  let wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "KYC Data");
  XLSX.writeFile(wb, "KYC_Report.xlsx");
}

// Placeholder notification
function sendNotification(phone, email, message) {
  console.log(`SMS to ${phone}: ${message}`);
  console.log(`Email to ${email}: ${message}`);
}
</script>

</body>
</html>
